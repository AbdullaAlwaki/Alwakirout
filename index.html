<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Alwaki Route</title>
  
  <!-- مكتبة Leaflet للخرائط -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  
  <!-- مكتبة الخطوط -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- ألوان السمة --- */
    :root {
      --color-primary: #38bdf8;
      --color-secondary: #10b981;
      --color-danger: #ef4444;
      --color-bg: #0f172a;
      --color-surface: #1e293b;
      --color-text: #fff;
      --color-border: #334155;
    }

    [data-theme="light"] {
      --color-bg: #ffffff;
      --color-surface: #f1f5f9;
      --color-text: #000000;
      --color-border: #cbd5e1;
      --color-primary: #0ea5e9;
      --color-secondary: #10b981;
      --color-danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Tajawal', sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      overflow: hidden;
      direction: rtl;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }

    /* --- شريط الأعلى --- */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: var(--color-surface);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .top-bar h1 {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .top-bar button {
      background: none;
      border: none;
      color: var(--color-text);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
    }

    .top-bar .tooltip {
      position: absolute;
      top: 56px;
      white-space: nowrap;
      background: var(--color-border);
      padding: 6px 12px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      font-size: 14px;
      z-index: 1001;
    }

    .top-bar button:hover + .tooltip,
    .top-bar button:focus + .tooltip {
      opacity: 1;
    }

    /* --- لوحة التحكم الجانبية --- */
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 50%;
      background: var(--color-surface);
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 16px;
      z-index: 1001;
      overflow-y: auto;
      transform: translateY(0%);
      transition: transform 0.3s ease;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    }

    .drag-handle {
      width: 40px;
      height: 5px;
      background: var(--color-border);
      border-radius: 3px;
      margin: 0 auto 12px;
      cursor: grab;
    }

    .section {
      margin-bottom: 12px;
    }

    .input-suggest {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: var(--color-border);
      color: var(--color-text);
    }

    .suggestions ul {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 16px;
      right: 16px;
      max-height: 140px;
      overflow-y: auto;
      background: #2a2a2a;
      border-radius: 8px;
      list-style: none;
      padding: 0;
      margin: 0;
      z-index: 1002;
      display: none;
    }

    .suggestions ul li {
      padding: 10px 14px;
      cursor: pointer;
      color: #eee;
    }

    .suggestions ul li:hover {
      background: #555;
    }

    /* --- قائمة المحطات --- */
    .stops-container {
      margin-bottom: 16px;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 12px;
    }

    .list-item {
      background: var(--color-border);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
    }

    .list-item span {
      flex: 1;
      word-break: break-word;
      color: var(--color-text);
    }

    .list-item button {
      background: var(--color-danger);
      border: none;
      border-radius: 6px;
      padding: 8px;
      cursor: pointer;
      color: var(--color-text);
      font-weight: bold;
    }

    /* --- زر إضافة محطة --- */
    #addStopBtn {
      width: 100%;
      padding: 14px;
      background: var(--color-secondary);
      color: var(--color-text);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    #addStopBtn:hover {
      background: #0f9b6f;
    }

    #addStopBtn i {
      margin-left: 10px;
      font-size: 20px;
    }

    /* --- خطوات الاتجاهات --- */
    .directions {
      flex: 1;
      overflow-y: auto;
      background: #24303d;
      border-radius: 8px;
      padding: 12px;
    }

    .directions h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: var(--color-text);
    }

    .directions ol {
      list-style: none;
      padding-left: 0;
    }

    .directions li {
      padding: 10px;
      background: #334155;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .directions li span.desc {
      flex: 1;
      color: #e0e0e0;
    }

    .directions li span.dist {
      margin-left: 10px;
      color: #bbb;
      white-space: nowrap;
    }

    /* --- أنماط Leaflet --- */
    .leaflet-popup-content {
      text-align: right;
      direction: rtl;
    }

    .leaflet-control-container .leaflet-routing-container {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      text-align: right;
    }

    /* --- أنماط الوضع النهاري --- */
    [data-theme="light"] .leaflet-popup-content,
    [data-theme="light"] .leaflet-control-container .leaflet-routing-container {
      direction: ltr;
      text-align: left;
    }

    /* --- علامات الخريطة --- */
    .leaflet-marker-label {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      direction: rtl;
    }

    /* --- تعديلات للهواتف --- */
    @media (min-width: 768px) {
      .bottom-sheet {
        height: 65%;
        max-width: 500px;
        left: 0;
        right: 0;
        margin: 0 auto;
        border-radius: 20px;
      }
      
      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: var(--color-surface);
        color: var(--color-text);
      }
    }
  </style>
</head>
<body data-theme="dark">
  <!-- شريط الأعلى -->
  <div class="top-bar">
    <h1>الواكي روت</h1>
    <button id="themeToggle" title="تبديل السمة">🌞</button>
    <div class="tooltip">تبديل السمة</div>
  </div>
  
  <!-- الخريطة -->
  <div id="map"></div>
  
  <!-- نموذج إخفاء لتحميل ملف GPX -->
  <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;">
  
  <!-- لوحة التحكم الجانبية -->
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    
    <!-- حقل نقطة البداية -->
    <div class="section suggestions">
      <input id="originInput" class="input-suggest" placeholder="نقطة البداية (اضغط للاختيار)">
      <ul id="originSug"></ul>
    </div>
    
    <!-- قائمة المحطات -->
    <div class="stops-container" id="stopsContainer">
      <div class="list" id="stopsList"></div>
    </div>
    
    <!-- حقل البحث عن محطة -->
    <div class="section suggestions">
      <input id="stopInput" class="input-suggest" placeholder="ابحث عن محطة توقف أو عنوان كامل">
      <ul id="stopSug"></ul>
    </div>
    
    <!-- زر إضافة محطة -->
    <button id="addStopBtn"><i>➕</i>أضف محطة/عنوان</button>
    
    <!-- خطوات الاتجاهات -->
    <div class="directions" id="directionsPanel">
      <h3>خطوات الاتجاهات</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>

  <script>
    // --- تفعيل السمة ---
    function initializeTheme() {
      const savedTheme = localStorage.getItem('app-theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
      document.getElementById('themeToggle').innerHTML = savedTheme === 'dark' ? '🌞' : '🌙';
    }

    // --- تبديل السمة ---
    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('app-theme', newTheme);
      document.getElementById('themeToggle').innerHTML = newTheme === 'dark' ? '🌞' : '🌙';
    }

    // --- إعداد الخريطة ---
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // --- معايير البحث ---
    const nominatimParams = 'format=json&addressdetails=1&accept-language=ar';
    
    // --- عناصر الواجهة ---
    const sheet = document.getElementById('sheet');
    const handle = document.getElementById('handle');
    const originInput = document.getElementById('originInput');
    const stopsList = document.getElementById('stopsList');
    const stopInput = document.getElementById('stopInput');
    const originSug = document.getElementById('originSug');
    const stopSug = document.getElementById('stopSug');
    
    // --- حالة التطبيق ---
    let originCoords, originMarker, routingControl;
    let stops = JSON.parse(localStorage.getItem('stops') || '[]');
    let stopMarkers = [];

    // --- عند تحميل الصفحة ---
    window.onload = () => {
      // --- تفعيل السمة ---
      initializeTheme();
      
      // --- إعداد الخريطة ---
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          p => {
            originCoords = [p.coords.latitude, p.coords.longitude];
            originInput.value = 'موقعي الحالي';
            setOrigin();
            routeStops();
          },
          e => console.warn('خطأ في الحصول على الموقع:', e)
        );
      }
      
      updateStops();
      
      // --- ربط أزرار التحكم ---
      setupButtonEvents();
      
      // --- تفعيل سحب اللوحة ---
      setupBottomSheet();
    };

    // --- سحب اللوحة الجانبية ---
    function setupBottomSheet() {
      handle.addEventListener('pointerdown', e => {
        let startY = e.clientY;
        let startT = 0;
        sheet.style.transition = 'none';
        
        const onDrag = e2 => {
          let dy = (e2.clientY - startY) / window.innerHeight * 100;
          let y = Math.min(Math.max(startT + dy, 0), 60);
          sheet.style.transform = `translateY(${y}%)`;
        };
        
        const onEnd = e2 => {
          let dy = (e2.clientY - startY) / window.innerHeight * 100;
          startT = Math.min(Math.max(startT + dy, 0), 60);
          sheet.style.transition = 'transform .3s';
          sheet.style.transform = `translateY(${startT}%)`;
          window.removeEventListener('pointermove', onDrag);
          window.removeEventListener('pointerup', onEnd);
        };
        
        window.addEventListener('pointermove', onDrag);
        window.addEventListener('pointerup', onEnd);
      });
    }

    // --- تفعيل الأزرار ---
    function setupButtonEvents() {
      // --- تبديل السمة ---
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // --- إضافة محطة ---
      document.getElementById('addStopBtn').addEventListener('click', () => {
        const q = stopInput.value.trim();
        if (!q) return;
        
        fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=1`)
          .then(response => response.json())
          .then(data => {
            if (data[0]) {
              const name = prompt('اسم مخصص:', data[0].display_name) || data[0].display_name;
              if (stops.some(s => s.name === name)) {
                alert('المحطة موجودة بالفعل!');
                return;
              }
              stops.push({ name, lat: +data[0].lat, lon: +data[0].lon });
              localStorage.setItem('stops', JSON.stringify(stops));
              updateStops();
              stopInput.value = '';
              routeStops();
            }
          })
          .catch(error => {
            alert('خطأ في إضافة المحطة');
            console.error('Error adding stop:', error);
          });
      });

      // --- النقر على الخريطة لإضافة محطة ---
      map.on('click', async e => {
        const { lat, lng } = e.latlng;
        try {
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?${nominatimParams}&lat=${lat}&lon=${lng}`
          );
          const data = await response.json();
          const displayName = data.display_name || 'موقع غير معروف';
          const name = prompt('الرجاء إدخال اسم للمحطة:', displayName) || displayName;
          stops.push({ name, lat, lon: lng });
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
        } catch (error) {
          console.error('خطأ في تحديد الموقع:', error);
          alert('فشل تحديد الموقع');
        }
      });
    }

    // --- تحديد نقطة البداية ---
    function setOrigin() {
      if (originMarker) map.removeLayer(originMarker);
      originMarker = createLabelMarker(originCoords, 'نقطة البداية');
      originMarker.addTo(map);
      map.setView(originCoords, 14);
    }

    // --- إنشاء علامة مع اسم ---
    function createLabelMarker(latlng, name) {
      return L.marker(latlng, {
        icon: L.divIcon({
          className: 'leaflet-marker-label',
          html: `<div>${name}</div>`,
          iconSize: [100, 30],
          iconAnchor: [50, 35],
          popupAnchor: [0, -35]
        })
      });
    }

    // --- تحديث قائمة المحطات ---
    function updateStops() {
      stopsList.innerHTML = '';
      if (stopMarkers) {
        stopMarkers.forEach(marker => map.removeLayer(marker));
      }
      stopMarkers = [];
      
      stops.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.draggable = true;
        div.dataset.index = i;
        div.innerHTML = `<span>${s.name}</span><button onclick="delStop(${i})">🗑️</button>`;
        
        // --- سحب المحطات ---
        div.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text', i);
        });
        
        div.addEventListener('dragover', e => {
          e.preventDefault();
          div.classList.add('drag-over');
        });
        
        div.addEventListener('dragleave', () => {
          div.classList.remove('drag-over');
        });
        
        div.addEventListener('drop', e => {
          e.preventDefault();
          div.classList.remove('drag-over');
          const from = +e.dataTransfer.getData('text');
          stops.splice(i, 0, stops.splice(from, 1)[0]);
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
        });
        
        // --- تعديل اسم المحطة ---
        div.querySelector('span').onclick = () => {
          const newStopName = prompt('تعديل اسم المحطة:', s.name);
          if (newStopName) {
            stops[i].name = newStopName;
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            routeStops();
          }
        };
        
        stopsList.appendChild(div);
        const marker = createLabelMarker([s.lat, s.lon], s.name);
        marker.addTo(map);
        stopMarkers.push(marker);
      });
    }

    // --- رسم المسار ---
    function routeStops() {
      if (!originCoords || stops.length === 0) {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        document.getElementById('directionsList').innerHTML = '';
        return;
      }
      
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      const waypoints = [
        L.latLng(originCoords),
        ...stops.map(s => L.latLng(s.lat, s.lon))
      ];
      
      routingControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: '#38bdf8', weight: 5 }] },
        routeWhileDragging: false,
        show: false,
        formatter: new L.Routing.Formatter({ language: 'ar', units: 'metric' })
      }).addTo(map);
      
      routingControl.on('routesfound', e => {
        const routes = e.routes;
        const dirList = document.getElementById('directionsList');
        dirList.innerHTML = '';
        
        if (!routes || routes.length === 0) {
          dirList.innerHTML = '<li>لم يتم العثور على مسار</li>';
          return;
        }
        
        routes[0].instructions.forEach(inst => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="desc">${inst.text}</span><span class="dist">${(inst.distance/1000).toFixed(1)} كم</span>`;
          dirList.appendChild(li);
        });
      });
      
      routingControl.on('error', e => {
        console.error('Routing error:', e.message);
      });
    }

    // --- البحث عن نقطة البداية ---
    originInput.addEventListener('input', async () => {
      const q = originInput.value;
      if (q.length < 2) {
        originSug.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`
        );
        const data = await response.json();
        originSug.innerHTML = '';
        originSug.style.display = 'block';
        
        data.forEach(p => {
          const li = document.createElement('li');
          li.textContent = p.display_name;
          li.onclick = () => {
            const label = prompt('اسم نقطة البداية:', p.display_name) || p.display_name;
            originInput.value = label;
            originCoords = [+p.lat, +p.lon];
            originSug.style.display = 'none';
            setOrigin();
            routeStops();
          };
          originSug.appendChild(li);
        });
      } catch (error) {
        console.error('خطأ في البحث عن نقطة البداية:', error);
      }
    });

    // --- البحث عن محطات ---
    stopInput.addEventListener('input', async () => {
      const q = stopInput.value;
      if (q.length < 2) {
        stopSug.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`
        );
        const data = await response.json();
        stopSug.innerHTML = '';
        stopSug.style.display = 'block';
        
        data.forEach(p => {
          const li = document.createElement('li');
          li.textContent = p.display_name;
          li.onclick = () => {
            const name = prompt('اسم مخصص:', p.display_name) || p.display_name;
            if (stops.some(s => s.name === name)) {
              alert('المحطة موجودة بالفعل!');
              return;
            }
            stops.push({ name, lat: +p.lat, lon: +p.lon });
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            stopInput.value = '';
            stopSug.style.display = 'none';
            routeStops();
          };
          stopSug.appendChild(li);
        });
      } catch (error) {
        console.error('خطأ في البحث عن محطات التوقف:', error);
      }
    });

    // --- حذف محطة ---
    window.delStop = i => {
      if (!confirm('هل تريد حذف هذه المحطة؟')) return;
      stops.splice(i, 1);
      localStorage.setItem('stops', JSON.stringify(stops));
      updateStops();
      routeStops();
    };

    // --- تفعيل وظائف الخريطة ---
    function setOrigin() {
      if (originMarker) map.removeLayer(originMarker);
      originMarker = createLabelMarker(originCoords, 'نقطة البداية');
      originMarker.addTo(map);
      map.setView(originCoords, 14);
    }

    // --- تفعيل الخريطة ---
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // --- تحديث قائمة المحطات ---
    function updateStops() {
      stopsList.innerHTML = '';
      if (stopMarkers) {
        stopMarkers.forEach(marker => map.removeLayer(marker));
      }
      stopMarkers = [];
      
      stops.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.draggable = true;
        div.dataset.index = i;
        div.innerHTML = `<span>${s.name}</span><button onclick="delStop(${i})">🗑️</button>`;
        
        // --- سحب المحطات ---
        div.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text', i);
        });
        
        div.addEventListener('dragover', e => {
          e.preventDefault();
          div.classList.add('drag-over');
        });
        
        div.addEventListener('dragleave', () => {
          div.classList.remove('drag-over');
        });
        
        div.addEventListener('drop', e => {
          e.preventDefault();
          div.classList.remove('drag-over');
          const from = +e.dataTransfer.getData('text');
          stops.splice(i, 0, stops.splice(from, 1)[0]);
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
        });
        
        stopsList.appendChild(div);
        const marker = createLabelMarker([s.lat, s.lon], s.name);
        marker.addTo(map);
        stopMarkers.push(marker);
      });
    }

    // --- رسم المسار ---
    function routeStops() {
      if (!originCoords || stops.length === 0) {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        document.getElementById('directionsList').innerHTML = '';
        return;
      }
      
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      const waypoints = [
        L.latLng(originCoords),
        ...stops.map(s => L.latLng(s.lat, s.lon))
      ];
      
      routingControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: '#38bdf8', weight: 5 }] },
        routeWhileDragging: false,
        show: false,
        formatter: new L.Routing.Formatter({ language: 'ar', units: 'metric' })
      }).addTo(map);
      
      routingControl.on('routesfound', e => {
        const routes = e.routes;
        const dirList = document.getElementById('directionsList');
        dirList.innerHTML = '';
        
        if (!routes || routes.length === 0) {
          dirList.innerHTML = '<li>لم يتم العثور على مسار</li>';
          return;
        }
        
        routes[0].instructions.forEach(inst => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="desc">${inst.text}</span><span class="dist">${(inst.distance/1000).toFixed(1)} كم</span>`;
          dirList.appendChild(li);
        });
      });
    }
  </script>
</body>
</html>
