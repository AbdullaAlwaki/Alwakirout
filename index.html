<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alwaki Route</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#fff;overflow:hidden}
    #map{position:absolute;top:0;left:0;right:0;bottom:0}
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    .language-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #1e293b;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 12px;
      z-index: 1001;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .language-bar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      margin: 0 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .language-bar .tooltip {
      position: fixed;
      left: 70px;
      background: #334155;
      padding: 6px 12px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      font-size: 14px;
    }
    
    .language-bar button:hover + .tooltip {
      opacity: 1;
    }

    /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 70%;
      background: #1e293b;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 15px;
      z-index: 1000;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .bottom-sheet.open {
      transform: translateY(0);
    }

    .drag-handle {
      width: 40px;
      height: 5px;
      background: #4b5563;
      border-radius: 3px;
      margin: 0 auto 10px;
      cursor: grab;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.2rem;
      color: #fff;
    }

    .section {
      position: relative;
      margin-bottom: 8px;
    }

    .input-suggest {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #334155;
      color: #fff;
    }

    .suggestions ul {
      position: absolute;
      bottom: calc(100% + 2px);
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: #2a2a2a;
      border-radius: 8px;
      list-style: none;
      padding: 0;
      margin: 0;
      z-index: 1002;
      display: none;
      direction: ltr;
    }

    .suggestions ul li {
      padding: 8px 12px;
      cursor: pointer;
      color: #eee;
      white-space: normal;
      line-height: 1.4;
    }

    .suggestions ul li:hover {
      background: #555;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 8px;
    }

    .list-item {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      cursor: grab;
    }

    .list-item.drag-over {
      border: 2px dashed #10b981;
    }

    .list-item span {
      flex: 1;
      word-break: break-word;
      color: #ddd;
    }

    .list-item button {
      background: #ef4444;
      border: none;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      color: #fff;
    }

    #addStopBtn {
      width: 100%;
      padding: 12px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #addStopBtn:hover {
      background: #0f9b6f;
    }

    #addStopBtn i {
      margin-left: 8px;
      font-size: 16px;
      width: 20px;
    }

    .directions {
      flex: 1;
      overflow-y: auto;
      background: #24303d;
      border-radius: 8px;
      padding: 10px;
    }

    .directions h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: #fff;
    }

    .directions ol {
      list-style: none;
      padding-left: 0;
    }

    .directions li {
      padding: 8px;
      background: #334155;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
    }

    .directions li span.desc {
      flex: 1;
      color: #e0e0e0;
    }

    .directions li span.dist {
      margin-left: 8px;
      color: #bbb;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .leaflet-popup-content {
      text-align: right;
      direction: rtl;
    }

    .leaflet-control-container .leaflet-routing-container {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      text-align: right;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø§ÙŠÙ‚ÙˆÙ†Ø§Øª */
    .icon-half {
      width: 50%;
      height: 50%;
      font-size: 16px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© */
    .saved-routes {
      margin-top: 12px;
      background: #24303d;
      border-radius: 8px;
      padding: 10px;
    }

    .saved-routes h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: #fff;
    }

    .saved-routes ul {
      list-style: none;
      padding-left: 0;
    }

    .saved-routes li {
      padding: 6px 8px;
      background: #334155;
      border-radius: 6px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }

    .saved-routes li button {
      background: transparent;
      border: none;
      color: #ef4444;
      font-size: 1rem;
      cursor: pointer;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª */
    .suggestions-container {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background: #2a2a2a;
      border-radius: 8px;
      padding: 0;
      margin: 0;
      z-index: 1002;
      display: none;
    }

    .suggestions-container li {
      padding: 8px 12px;
      cursor: pointer;
      color: #eee;
      white-space: normal;
      line-height: 1.4;
    }

    .suggestions-container li:hover {
      background: #555;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ */
    .search-container {
      position: relative;
    }

    .search-container input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #334155;
      color: #fff;
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .controls button {
      flex: 1 1 calc(50% - 4px);
      min-width: calc(50% - 4px);
      padding: 10px;
      font-size: 0.9rem;
    }

    @media (max-width: 640px) {
      .controls button {
        flex: 1 1 100%;
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="language-bar">
    <button id="langArBtn">
      <i class="icon-half">â­</i> Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
    </button>
    <div class="tooltip">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</div>
    
    <button id="langEnBtn">
      <i class="icon-half">â­</i> English
    </button>
    <div class="tooltip">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</div>
  </div>
  
  <div id="map"></div>
  
  <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    <h2>Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ§ÙƒÙŠ</h2>
    
    <!-- Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div class="section search-container">
      <input id="originInput" class="input-suggest" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±)">
      <ul id="originSug" class="suggestions-container"></ul>
    </div>
    
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª -->
    <div class="list" id="stopsList"></div>
    
    <!-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø© -->
    <div class="section search-container">
      <input id="stopInput" class="input-suggest" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø© ØªÙˆÙ‚Ù Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† ÙƒØ§Ù…Ù„">
      <ul id="stopSug" class="suggestions-container"></ul>
    </div>
    
    <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© -->
    <button id="addStopBtn"><i>â•</i>Ø£Ø¶Ù Ù…Ø­Ø·Ø©/Ø¹Ù†ÙˆØ§Ù†</button>
    
    <!-- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª -->
    <div class="directions" id="directionsPanel">
      <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>

  <script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // --- Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« ---
    const nominatimParams = 'format=json&addressdetails=1&accept-language=ar';
    
    // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    const sheet = document.getElementById('sheet');
    const handle = document.getElementById('handle');
    const originInput = document.getElementById('originInput');
    const stopsList = document.getElementById('stopsList');
    const stopInput = document.getElementById('stopInput');
    const originSug = document.getElementById('originSug');
    const stopSug = document.getElementById('stopSug');
    
    // --- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    let originCoords, originMarker, routingControl;
    let stops = JSON.parse(localStorage.getItem('stops') || '[]');
    let stopMarkers = [];
    let preferredLanguage = localStorage.getItem('preferredLanguage') || 'ar';

    // --- ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙØ¶Ù„ ---
    function updateFavoriteIcons() {
      const isArFav = preferredLanguage === 'ar' ? 'â˜…' : 'â˜†';
      const isEnFav = preferredLanguage === 'en' ? 'â˜…' : 'â˜†';
      document.querySelector('#langArBtn .icon-half').innerHTML = isArFav;
      document.querySelector('#langEnBtn .icon-half').innerHTML = isEnFav;
    }

    // --- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© ---
    function toggleLanguage(lang) {
      if (lang === 'ar') {
        preferredLanguage = 'ar';
        alert('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©');
      } else {
        preferredLanguage = 'en';
        alert('Switched to English');
      }
      localStorage.setItem('preferredLanguage', preferredLanguage);
      updateFavoriteIcons();
      
      // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¯ Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù„ØºØ© Ø¬Ø¯ÙŠØ¯Ø©
      // Ù‡Ø°Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†ØµÙˆØµ ÙˆØ¹Ù†Ø§ØµØ± Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù… ØªÙÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    }

    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
    window.onload = () => {
      updateFavoriteIcons();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          p => {
            originCoords = [p.coords.latitude, p.coords.longitude];
            originInput.value = 'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';
            setOrigin();
            routeStops();
          },
          e => console.warn('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', e)
        );
      }
      updateStops();
      
      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„ØºØ©
      document.getElementById('langArBtn').addEventListener('click', () => toggleLanguage('ar'));
      document.getElementById('langEnBtn').addEventListener('click', () => toggleLanguage('en'));
    };

    // --- ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
    function setOrigin() {
      if (originMarker) map.removeLayer(originMarker);
      originMarker = L.marker(originCoords)
        .addTo(map)
        .bindPopup('Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©')
        .openPopup();
      map.setView(originCoords, 14);
    }

    // --- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
    originInput.addEventListener('input', async () => {
      const q = originInput.value;
      if (q.length < 2) {
        originSug.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`
        );
        const data = await response.json();
        originSug.innerHTML = '';
        originSug.style.display = 'block';
        
        data.forEach(p => {
          const li = document.createElement('li');
          li.textContent = p.display_name;
          li.onclick = () => {
            const label = prompt('Ø§Ø³Ù… Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:', p.display_name) || p.display_name;
            originInput.value = label;
            originCoords = [+p.lat, +p.lon];
            originSug.style.display = 'none';
            setOrigin();
            routeStops();
          };
          originSug.appendChild(li);
        });
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:', error);
      }
    });

    // --- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø§Øª ---
    stopInput.addEventListener('input', async () => {
      const q = stopInput.value;
      if (q.length < 2) {
        stopSug.style.display = 'none';
        return;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`
        );
        const data = await response.json();
        stopSug.innerHTML = '';
        stopSug.style.display = 'block';
        
        data.forEach(p => {
          const li = document.createElement('li');
          li.textContent = p.display_name;
          li.onclick = () => {
            const name = prompt('Ø§Ø³Ù… Ù…Ø®ØµØµ:', p.display_name) || p.display_name;
            stops.push({ name, lat: +p.lat, lon: +p.lon });
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            stopInput.value = '';
            stopSug.style.display = 'none';
            routeStops();
          };
          stopSug.appendChild(li);
        });
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù:', error);
      }
    });

    // --- Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ---
    map.on('click', async e => {
      const { lat, lng } = e.latlng;
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?${nominatimParams}&lat=${lat}&lon=${lng}`
        );
        const data = await response.json();
        const displayName = data.display_name || 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const name = prompt('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ù…Ø­Ø·Ø©:', displayName) || displayName;
        stops.push({ name, lat, lon: lng });
        localStorage.setItem('stops', JSON.stringify(stops));
        updateStops();
        routeStops();
      } catch (error) {
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹');
        console.error('Error reverse geocoding:', error);
      }
    });

    // --- Ø³Ø­Ø¨ Ø§Ù„Ù„ÙˆØ­Ø© ---
    handle.addEventListener('pointerdown', e => {
      let startY = e.clientY;
      let startT = 100;
      sheet.style.transition = 'none';
      const onDrag = e2 => {
        let dy = (e2.clientY - startY) / window.innerHeight * 100;
        let y = Math.min(Math.max(startT + dy, 0), 100);
        sheet.style.transform = `translateY(${y}%)`;
      };
      const onEnd = e2 => {
        let dy = (e2.clientY - startY) / window.innerHeight * 100;
        startT = Math.min(Math.max(startT + dy, 0), 100);
        sheet.style.transition = 'transform .3s';
        sheet.style.transform = `translateY(${startT}%)`;
        window.removeEventListener('pointermove', onDrag);
        window.removeEventListener('pointerup', onEnd);
      };
      window.addEventListener('pointermove', onDrag);
      window.addEventListener('pointerup', onEnd);
    });

    // --- Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ---
    document.getElementById('addStopBtn').onclick = async () => {
      const q = stopInput.value.trim();
      if (!q) return;
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=1`
        );
        const data = await response.json();
        if (data[0]) {
          const name = prompt('Ø§Ø³Ù… Ù…Ø®ØµØµ:', data[0].display_name) || data[0].display_name;
          stops.push({ name, lat: +data[0].lat, lon: +data[0].lon });
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          stopInput.value = '';
          routeStops();
        }
      } catch (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø·Ø©');
        console.error('Error adding stop:', error);
      }
    };

    // --- ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª ---
    function updateStops() {
      stopsList.innerHTML = '';
      if (stopMarkers) {
        stopMarkers.forEach(marker => map.removeLayer(marker));
      }
      stopMarkers = [];
      
      stops.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.draggable = true;
        div.dataset.index = i;
        div.innerHTML = `<span>${s.name}</span><button>ğŸ—‘ï¸</button>`;
        
        div.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text', i);
        });
        
        div.addEventListener('dragover', e => {
          e.preventDefault();
          div.classList.add('drag-over');
        });
        
        div.addEventListener('dragleave', () => {
          div.classList.remove('drag-over');
        });
        
        div.addEventListener('drop', e => {
          e.preventDefault();
          div.classList.remove('drag-over');
          const from = +e.dataTransfer.getData('text');
          stops.splice(i, 0, stops.splice(from, 1)[0]);
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
        });
        
        div.querySelector('span').onclick = () => {
          const newStopName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©:', s.name);
          if (newStopName) {
            stops[i].name = newStopName;
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            routeStops();
          }
        };
        
        stopsList.appendChild(div);
        const marker = L.marker([s.lat, s.lon]).addTo(map).bindPopup(s.name);
        stopMarkers.push(marker);
      });
    }

    // --- Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± ---
    function routeStops() {
      if (!originCoords || stops.length === 0) return;
      
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      const waypoints = [
        L.latLng(originCoords),
        ...stops.map(s => L.latLng(s.lat, s.lon))
      ];
      
      routingControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: '#38bdf8', weight: 5 }] },
        routeWhileDragging: false,
        show: false,
        formatter: new L.Routing.Formatter({
          language: 'ar',
          units: 'metric'
        })
      }).addTo(map);
      
      routingControl.on('routesfound', e => {
        const routes = e.routes;
        const dirList = document.getElementById('directionsList');
        dirList.innerHTML = '';
        
        if (!routes || routes.length === 0) {
          dirList.innerHTML = '<li>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø±</li>';
          return;
        }
        
        routes[0].instructions.forEach(inst => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="desc">${inst.text}</span><span class="dist">${(inst.distance/1000).toFixed(1)} ÙƒÙ…</span>`;
          dirList.appendChild(li);
        });
      });
    }

    // --- Ø­Ø°Ù Ù…Ø­Ø·Ø© ---
    window.delStop = i => {
      stops.splice(i, 1);
      localStorage.setItem('stops', JSON.stringify(stops));
      updateStops();
      routeStops();
    };

    // --- ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
    function setOrigin() {
      if (originMarker) map.removeLayer(originMarker);
      originMarker = L.marker(originCoords)
        .addTo(map)
        .bindPopup('Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©')
        .openPopup();
      map.setView(originCoords, 14);
    }
  </script>
</body>
</html>
