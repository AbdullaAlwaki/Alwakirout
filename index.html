
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#fafafa" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>

  <!-- Ø®Ø· Ø´Ø¨ÙŠÙ‡ Ø¨Ù€ SF Pro Text -->
  <style>
    @font-face {
      font-family: 'SF Pro Text';
      font-weight: 400;
      src: local('.SFNSText-Regular'), local('SF Pro Text Regular');
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      background: #ffffff;
      color: #1c1c1e;
    }
  </style>

  <!-- Leaflet Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª -->
  <link
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    #map { height: 100vh; }

    /* Ø²Ø± Ø§Ù„ÙØªØ­/Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ */
    .sheet-toggle {
      position: fixed;
      bottom: 20px; right: 20px;
      width: 60px; height: 60px;
      background: rgba(0, 122, 255, 0.9);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      cursor: pointer; z-index: 1001;
      transition: transform 0.3s;
    }
    .sheet-toggle:hover { transform: scale(1.1); }

    /* Ø§Ù„Ù€ Bottom Sheet */
    .bottom-sheet {
      position: fixed;
      bottom: -100%; left: 0; right: 0;
      height: 60%;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(20px); /* Ø·Ù…Ø³ Ø®Ù„ÙÙŠ Ø®ÙÙŠÙ */  [oai_citation:0â€¡MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/CSS/backdrop-filter?utm_source=chatgpt.com)
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 16px;
      display: flex; flex-direction: column;
      z-index: 1000;
      transition: bottom 0.3s;
    }
    .bottom-sheet.open { bottom: 0; }

    /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
    .input {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      border: none;
      border-radius: 12px;
      background: #f2f2f7;
      color: #1c1c1e;
      font-size: 1rem;
    }
    .input:focus {
      outline: 2px solid rgba(0,122,255,0.8);
      background: #ffffff;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
    .list {
      flex: 1;
      overflow-y: auto;
      margin: 12px 0;
    }
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 6px;
      background: #ffffff;
      border-radius: 12px;
      color: #1c1c1e;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .list-item:hover {
      background: #f2f2f7;
    }

    /* Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†Ù‚Ù„ */
    #routeBtn {
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: rgba(0, 122, 255, 0.9);
      color: #ffffff;
      font-weight: 600;
    }

    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    #loader {
      position: fixed;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(28,28,30,0.9);
      color: #fff;
      padding: 10px 16px;
      border-radius: 12px;
      display: none;
      z-index: 1100;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="sheet-toggle" id="toggleBtn">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24">
      <path fill="#fff" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
  </div>

  <div class="bottom-sheet" id="sheet">
    <h2 style="font-size:1.2rem; font-weight:600; margin-bottom:12px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
    <input id="originInput" class="input" placeholder="Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" readonly />
    <div id="geocoder" class="input"></div>
    <div id="list" class="list"></div>
    <button id="routeBtn">ğŸš— Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†Ù‚Ù„</button>
  </div>

  <div id="loader">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <script>
    // Debounce Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    function debounce(fn, delay) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // Ø§Ù„Ø­Ø§Ù„Ø©
    const state = {
      origin: null,
      addresses: JSON.parse(localStorage.getItem('addresses')) || []
    };

    // Ø¹Ù†Ø§ØµØ± DOM
    const map = L.map('map').setView([24, 45], 6);
    const originInput = document.getElementById('originInput');
    const geocoderEl = document.getElementById('geocoder');
    const listEl = document.getElementById('list');
    const loader = document.getElementById('loader');
    let routingControl;

    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    const markersCluster = L.markerClusterGroup().addTo(map);

    // Service Worker Ù„Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ sheet
    const sheet = document.getElementById('sheet');
    document.getElementById('toggleBtn').onclick = () => {
      sheet.classList.toggle('open');
    };
    const hammer = new Hammer(sheet);
    hammer.get('pan').set({ direction: Hammer.DIRECTION_VERTICAL });
    hammer.on('panend', ev => {
      if (ev.deltaY > 100) sheet.classList.remove('open');
    });

    // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ loader
    function showLoader(){ loader.style.display = 'block'; }
    function hideLoader(){ loader.style.display = 'none'; }

    // ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    function setOrigin(latlng, name) {
      state.origin = { lat: latlng.lat, lng: latlng.lng, name };
      localStorage.setItem('origin', JSON.stringify(state.origin));
      originInput.value = name;
      if (window.originMarker) map.removeLayer(window.originMarker);
      window.originMarker = L.marker(latlng, { draggable: true })
        .addTo(map)
        .bindPopup(name).openPopup();
      window.originMarker.on('dragend', e => {
        setOrigin(e.target.getLatLng(), name);
      });
    }

    // ØªØ­Ù…ÙŠÙ„ origin Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø£Ùˆ geolocate
    const savedOrigin = JSON.parse(localStorage.getItem('origin'));
    if (savedOrigin) {
      setOrigin(L.latLng(savedOrigin.lat, savedOrigin.lng), savedOrigin.name);
    } else {
      navigator.geolocation.getCurrentPosition(pos => {
        const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
        geocode(ll, res => { if (res) setOrigin(ll, res.display_name); });
      });
    }

    // Ø¬ÙŠÙˆÙƒÙˆØ¯ Ø¹Ø§Ù…
    function geocode(query, cb) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => cb(data[0] || null))
        .catch(() => cb(null));
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    state.addresses.forEach(addMarker);
    renderAddresses();

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ±
    function addMarker(item) {
      const lat = item.lat || item[0], lng = item.lon || item[1];
      const name = item.display_name || item.name;
      L.marker([lat, lng]).bindPopup(name).addTo(markersCluster);
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function renderAddresses() {
      listEl.innerHTML = '';
      state.addresses.forEach((addr, i) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <span>${addr.name}</span>
          <div class="space-x-2">
            <button onclick="editAddress(${i})">âœï¸</button>
            <button onclick="deleteAddress(${i})">ğŸ—‘ï¸</button>
          </div>
        `;
        listEl.appendChild(div);
      });
      new Sortable(listEl, {
        animation: 150,
        onEnd: () => {
          state.addresses = Array.from(listEl.children).map(el => {
            const name = el.querySelector('span').textContent;
            return state.addresses.find(a => a.name === name);
          });
          localStorage.setItem('addresses', JSON.stringify(state.addresses));
        }
      });
    }

    window.deleteAddress = i => {
      Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      }).then(res => {
        if (res.isConfirmed) {
          state.addresses.splice(i,1);
          localStorage.setItem('addresses', JSON.stringify(state.addresses));
          renderAddresses();
          markersCluster.clearLayers();
          state.addresses.forEach(addMarker);
        }
      });
    };

    window.editAddress = i => {
      const newName = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯', state.addresses[i].name);
      if (newName) {
        state.addresses[i].name = newName;
        localStorage.setItem('addresses', JSON.stringify(state.addresses));
        renderAddresses();
      }
    };

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
    document.getElementById('routeBtn').onclick = () => {
      if (!state.origin || state.addresses.length === 0) {
        return Swal.fire('Ø®Ø·Ø£','Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ£Ø¶Ù Ø¹Ù†Ø§ÙˆÙŠÙ†','error');
      }
      if (routingControl) map.removeControl(routingControl);
      const wps = [
        L.latLng(state.origin.lat, state.origin.lng),
        ...state.addresses.map(a => L.latLng(a.lat, a.lng))
      ];
      routingControl = L.Routing.control({
        waypoints: wps,
        lineOptions: { styles:[{weight:6}] }
      }).addTo(map);
      routingControl.on('routesfound', e => {
        const r = e.routes[0];
        const dist = (r.summary.totalDistance/1000).toFixed(1);
        const time = Math.round((r.summary.totalTime%3600)/60);
        Swal.fire('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±',`Ø§Ù„Ù…Ø³Ø§ÙØ©: ${dist} ÙƒÙ…<br>Ø§Ù„ÙˆÙ‚Øª: ${time} Ø¯Ù‚Ø§Ø¦Ù‚`,'info');
      });
    };
  </script>
</body>
</html>
