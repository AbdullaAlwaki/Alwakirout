<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Alwaki Route</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    /* --- Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØµÙØ­Ø© ÙƒÙ…Ø§ Ù‡ÙŠ --- */
    * { margin:0; padding:0; box-sizing:border-box }
    html, body {
      font-family:'Segoe UI',sans-serif;
      background:#0f172a; color:#fff;
      height:100%; overflow:hidden;
    }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:1; }
    .left-bar { position:fixed; top:0; left:0; width:56px; height:35%;
      background:#1e293b; display:flex; flex-direction:column; align-items:center;
      padding:12px 0; z-index:1001; box-shadow:2px 0 4px rgba(0,0,0,0.3);
    }
    .left-bar button { background:none; border:none; color:#fff;
      font-size:20px; padding:10px; cursor:pointer; margin:4px 0;
    }
    .left-bar button:hover { background:#334155; border-radius:8px }
    .left-bar .tooltip {
      position:fixed; right:60px; background:#334155; padding:6px 12px;
      border-radius:6px; opacity:0; transition:opacity .3s;
      pointer-events:none; font-size:14px; white-space:nowrap; z-index:1002;
    }
    .left-bar button:hover + .tooltip { opacity:1 }
    .bottom-sheet {
      position:fixed; left:0; right:0; bottom:0; height:65%;
      background:#1e293b; border-top-left-radius:20px;
      border-top-right-radius:20px; padding:15px; overflow-y:auto;
      z-index:1000; transform:translateY(60%); transition:transform .3s ease;
    }
    .bottom-sheet.open { transform:translateY(0) }
    .drag-handle {
      width:40px; height:5px; background:#4b5563;
      margin:0 auto 10px; border-radius:3px; cursor:grab;
    }
    .section { position:relative; margin-bottom:8px }
    .input-suggest {
      width:100%; padding:10px; border:none; border-radius:8px;
      background:#334155; color:#fff; font-size:1rem;
    }
    .suggestions ul {
      position:absolute; bottom:calc(100%+2px); left:0; right:0;
      max-height:140px; overflow-y:auto; background:#2a2a2a;
      border-radius:8px; list-style:none; padding:0; margin:0;
      z-index:1002; display:none;
    }
    .suggestions ul li {
      padding:8px 12px; cursor:pointer; color:#eee;
    }
    .suggestions ul li:hover { background:#555 }

    .list { flex:1; overflow-y:auto; margin-bottom:8px }
    .list-item {
      display:flex; align-items:center; background:#2a2a2a;
      padding:8px; border-radius:8px; margin-bottom:6px; cursor:grab;
    }
    .list-item.drag-over { border:2px dashed #10b981 }
    .list-item span { flex:1; color:#ddd; word-break:break-word }
    .list-item button {
      background:#ef4444; border:none; border-radius:6px;
      padding:6px; color:#fff; cursor:pointer; margin-left:8px;
    }

    #addStopBtn {
      width:100%; padding:12px; background:#10b981; color:#fff;
      border:none; border-radius:8px; font-size:1rem;
      cursor:pointer; margin-bottom:8px; display:flex;
      align-items:center; justify-content:center;
    }
    #addStopBtn:hover { background:#0f9b6f }

    .directions {
      flex:1; overflow-y:auto; background:#24303d;
      border-radius:8px; padding:10px;
    }
    .directions h3 {
      text-align:center; margin-bottom:8px; color:#fff;
    }
    .directions ol { list-style:none; padding:0 }
    .directions li {
      display:flex; align-items:center;
      background:#334155; padding:8px; border-radius:6px;
      margin-bottom:6px;
    }
    .directions li .desc { flex:1; color:#e0e0e0 }
    .directions li .dist { margin-left:8px; color:#bbb }

    .custom-marker {
      background:#334155; color:#fff; padding:4px 8px;
      border-radius:4px; font-size:12px; text-align:center;
    }
    .origin-marker { background:#10b981 !important }
    .stop-marker { background:#ef4444 !important }
  </style>
</head>

<body>
  <div class="left-bar">
    <button id="locationBtn"><i>ğŸ“</i></button><div class="tooltip">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
    <button id="addStopBtn"><i>â•</i></button><div class="tooltip">Ø£Ø¶Ù Ù…Ø­Ø·Ø©</div>
    <button id="saveRouteBtn"><i>ğŸ’¾</i></button><div class="tooltip">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±</div>
    <button id="importGPXBtn"><i>ğŸ“‚</i></button><div class="tooltip">Ø§Ø³ØªÙŠØ±Ø§Ø¯ GPX</div>
    <button id="exportGPXBtn"><i>ğŸ“</i></button><div class="tooltip">ØªØµØ¯ÙŠØ± GPX</div>
    <button id="shareRouteBtn"><i>ğŸ”—</i></button><div class="tooltip">Ù…Ø´Ø§Ø±ÙƒØ©</div>
    <button id="clearRouteBtn"><i>ğŸ—‘ï¸</i></button><div class="tooltip">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³Ø§Ø±</div>
  </div>

  <div id="map"></div>
  <input type="file" id="gpxFileInput" accept=".gpx" style="display:none;">

  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>

    <div class="section suggestions">
      <input id="originInput" class="input-suggest" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©">
      <ul id="originSug"></ul>
    </div>

    <div class="list" id="stopsList"></div>

    <div class="section suggestions">
      <input id="stopInput" class="input-suggest" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø© ØªÙˆÙ‚Ù">
      <ul id="stopSug"></ul>
    </div>

    <div class="directions">
      <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Routing Machine JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <!-- Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    const map = L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'Â© OpenStreetMap'
    }).addTo(map);
    const nominatimParams = 'format=json&addressdetails=1&accept-language=ar';

    let originCoords = null, originMarker = null, routingControl = null;
    let stops = JSON.parse(localStorage.getItem('stops')||'[]');
    let stopMarkers = [];
    let userCountry = '', userCity = '';

    // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø¯ ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø¨ÙˆØ§Ø³Ø·Ø© IP
    async function setCountryFromIP(){
      try{
        const res = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        userCountry = data.country_name || '';
        userCity = data.city || data.region || '';
        if(data.latitude&&data.longitude){
          originCoords=[data.latitude,data.longitude];
          updateOriginMarker();
          routeStops();
        }
      }catch{}
    }

    function updateOriginMarker(){
      if(originMarker) map.removeLayer(originMarker);
      if(originCoords){
        originMarker = L.marker(originCoords,{
          icon:L.divIcon({className:'custom-marker origin-marker',html:'<div>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>'})
        }).addTo(map);
        map.setView(originCoords,14);
      }
    }

    function updateStops(){
      const list=document.getElementById('stopsList');
      list.innerHTML=''; stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[];
      stops.forEach((s,i)=>{
        const div=document.createElement('div');
        div.className='list-item'; div.draggable=true; div.dataset.index=i;
        div.innerHTML=`<span>${s.name}</span><button onclick="delStop(${i})">ğŸ—‘ï¸</button>`;
        div.addEventListener('dragstart',e=>e.dataTransfer.setData('text',i));
        div.addEventListener('dragover',e=>{e.preventDefault();div.classList.add('drag-over')});
        div.addEventListener('dragleave',()=>div.classList.remove('drag-over'));
        div.addEventListener('drop',e=>{
          e.preventDefault();div.classList.remove('drag-over');
          const from=+e.dataTransfer.getData('text');
          stops.splice(i,0,stops.splice(from,1)[0]);
          localStorage.setItem('stops',JSON.stringify(stops));
          updateStops(); routeStops();
        });
        div.querySelector('span').onclick=()=>{ 
          const name=prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©:',s.name);
          if(name){ stops[i].name=name; localStorage.setItem('stops',JSON.stringify(stops)); updateStops(); routeStops(); }
        };
        list.appendChild(div);
        const m=L.marker([s.lat,s.lon],{
          icon:L.divIcon({className:'custom-marker stop-marker',html:`<div>${s.name}</div>`})
        }).addTo(map);
        stopMarkers.push(m);
      });
    }

    function setupButtonEvents(){
      document.getElementById('locationBtn').addEventListener('click',()=>{
        if(!navigator.geolocation) return alert('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
        navigator.geolocation.getCurrentPosition(p=>{
          originCoords=[p.coords.latitude,p.coords.longitude];
          updateOriginMarker(); routeStops();
        },()=>setCountryFromIP(),{enableHighAccuracy:true,timeout:5000});
      });

      // Ø§Ù‚ØªØ±Ø§Ø­ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨Ù„Ø¯ ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø©
      document.getElementById('originInput').addEventListener('input', async e=>{
        const q=e.target.value, sug=document.getElementById('originSug');
        if(q.length<2) return sug.style.display='none';
        const res=await fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`);
        const data=await res.json();
        sug.innerHTML=''; sug.style.display='block';
        data.forEach(p=>{
          const text = userCountry && userCity
            ? `${userCountry}, ${userCity} â€” ${p.display_name}`
            : p.display_name;
          const li=document.createElement('li');
          li.textContent=text;
          li.onclick=()=>{
            originCoords=[+p.lat,+p.lon];
            updateOriginMarker(); routeStops();
            sug.style.display='none';
            e.target.value=p.display_name;
          };
          sug.appendChild(li);
        });
      });

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªÙ‡Ø§ Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù„ÙˆØ¨
      document.getElementById('stopInput').addEventListener('input',async e=>{
        const q=e.target.value, sug=document.getElementById('stopSug');
        if(q.length<2) return sug.style.display='none';
        const res=await fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`);
        const data=await res.json();
        sug.innerHTML=''; sug.style.display='block';
        data.forEach(p=>{
          const text = userCountry && userCity
            ? `${userCountry}, ${userCity} â€” ${p.display_name}`
            : p.display_name;
          const li=document.createElement('li');
          li.textContent=text;
          li.onclick=()=>{
            const name=prompt('Ø§Ø³Ù… Ù…Ø®ØµØµ:',p.display_name)||p.display_name;
            if(stops.some(s=>s.name===name)) return alert('Ø§Ù„Ù…Ø­Ø·Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©');
            stops.push({name,lat:+p.lat,lon:+p.lon});
            localStorage.setItem('stops',JSON.stringify(stops));
            updateStops(); routeStops();
            sug.style.display='none';
            e.target.value='';
          };
          sug.appendChild(li);
        });
      });

      document.getElementById('addStopBtn').addEventListener('click',()=> {
        const q=document.getElementById('stopInput').value.trim();
        if(!q) return;
        document.getElementById('stopInput').dispatchEvent(new Event('input'));
      });

      document.getElementById('saveRouteBtn').addEventListener('click',()=>{
        if(!stops.length&& !originCoords) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù„Ù„Ø­ÙØ¸');
        const name=prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±:'); if(!name) return;
        const arr=JSON.parse(localStorage.getItem('savedRoutes')||'[]');
        arr.push({name,origin:originCoords,stops});
        localStorage.setItem('savedRoutes',JSON.stringify(arr));
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±');
      });

      document.getElementById('importGPXBtn').addEventListener('click',()=>document.getElementById('gpxFileInput').click());
      document.getElementById('gpxFileInput').addEventListener('change',e=>{
        const file=e.target.files[0]; if(!file) return;
        const r=new FileReader();
        r.onload=()=>{
          const xml=new DOMParser().parseFromString(r.result,'text/xml');
          const wpts=xml.getElementsByTagName('wpt'); 
          if(!wpts.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø·');
          stops=[]; for(let i=0;i<wpts.length;i++){
            const n=wpts[i];
            stops.push({
              name:n.getElementsByTagName('name')[0]?.textContent||`Ù…Ø­Ø·Ø© ${i+1}`,
              lat:parseFloat(n.getAttribute('lat')),
              lon:parseFloat(n.getAttribute('lon'))
            });
          }
          localStorage.setItem('stops',JSON.stringify(stops));
          updateStops(); routeStops();
          alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${stops.length} Ù†Ù‚Ø·Ø©`);
        };
        r.onerror=()=>alert('Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© GPX'); r.readAsText(file);
      });

      document.getElementById('exportGPXBtn').addEventListener('click',()=>{
        if(!stops.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ù„Ù„ØªØµØ¯ÙŠØ±');
        let gpx=`<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="Alwaki Route"><metadata><time>${new Date().toISOString()}</time></metadata>`;
        stops.forEach(s=>gpx+=`<wpt lat="${s.lat}" lon="${s.lon}"><name>${s.name}</name></wpt>`);
        gpx+='</gpx>';
        const blob=new Blob([gpx],{type:'application/gpx+xml'});
        const url=URL.createObjectURL(blob), a=document.createElement('a');
        a.href=url; a.download=`route-${Date.now()}.gpx`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      document.getElementById('shareRouteBtn').addEventListener('click',()=>{
        if(!originCoords||!stops.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
        const data={origin:originCoords,stops:stops.map(s=>[s.lat,s.lon])};
        const url=`${location.origin+location.pathname}?route=${encodeURIComponent(JSON.stringify(data))}`;
        navigator.clipboard?.writeText(url).then(()=>alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')).catch(()=>prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:',url));
      });

      document.getElementById('clearRouteBtn').addEventListener('click',()=>{
        if(!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ')) return;
        stops=[]; originCoords=null; localStorage.removeItem('stops');
        if(originMarker) map.removeLayer(originMarker);
        if(routingControl) map.removeControl(routingControl);
        document.getElementById('directionsList').innerHTML='';
      });
    }

    function routeStops(){
      if(!originCoords||stops.length<1){
        if(routingControl) map.removeControl(routingControl);
        return;
      }
      if(routingControl) map.removeControl(routingControl);
      const waypoints=[L.latLng(originCoords),...stops.map(s=>L.latLng(s.lat,s.lon))];
      const router=new L.Routing.OSRMv1({
        serviceUrl:'https://router.project-osrm.org/route/v1',
        profile:'driving'
      }); /* OSRMv1 proper */ 
      routingControl=L.Routing.control({
        waypoints,router,
        lineOptions:{styles:[{weight:5}]},
        showAlternatives:false,
        formatter:new L.Routing.Formatter({language:'ar',units:'metric'})
      }).addTo(map);
      routingControl.on('routingerror',err=>{
        console.error(err); alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.');
      });
    }

    window.delStop=i=>{
      stops.splice(i,1);
      localStorage.setItem('stops',JSON.stringify(stops));
      updateStops(); routeStops();
    };

    window.onload=()=>{
      setCountryFromIP();
      updateStops();
      setupButtonEvents();
      routeStops();
    };
  </script>
</body>
</html>
