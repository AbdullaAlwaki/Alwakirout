<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e293b">
  <title>Alwaki Route</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#fff;overflow:hidden}
    #map{position:absolute;top:0;left:0;right:0;bottom:0}
    .sheet-toggle{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:#10b981;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1001}
    .sheet-toggle i{color:#fff;font-size:1.5rem}
    .bottom-sheet{position:fixed;left:0;right:0;height:60%;background:rgba(30,30,30,0.95);backdrop-filter:blur(8px);border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;display:none;flex-direction:column;z-index:1000;overflow:hidden;touch-action:none}
    .bottom-sheet.open{display:flex}
    .drag-handle{width:50px;height:5px;background:#4b5563;border-radius:3px;margin:0 auto 10px;cursor:grab}
    h2{text-align:center;margin-bottom:10px}
    .input{width:100%;margin-bottom:12px;padding:14px;border:none;border-radius:10px;font-size:1rem;background:#334155;color:#fff}
    button{width:100%;margin-bottom:12px;padding:14px;border:none;border-radius:10px;font-size:1rem;background:#10b981;color:#fff;cursor:pointer}
    .list{flex:1;overflow-y:auto;margin-bottom:12px}
    .list-item{background:#1f2937;padding:12px;border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .list-item span{flex:1;word-break:break-word}
    .list-item button{margin-left:8px;padding:6px 10px;font-size:0.9rem;border:none;border-radius:8px;cursor:pointer}
    .edit-btn{background:#f59e0b;color:#000}
    .delete-btn{background:#ef4444;color:#fff}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="sheet-toggle" id="toggleBtn"><i>&#9776;</i></div>
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    <h2>Alwaki Route</h2>
    <input id="originInput" class="input" readonly placeholder="ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹...">
    <button id="editOriginBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
    <input id="addressInput" class="input" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„">
    <button id="addBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
    <div class="list" id="list"></div>
    <button id="routeBtn">ğŸš— Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†Ù‚Ù„</button>
  </div>
  <script>
    const map=L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const sheet=document.getElementById('sheet'),toggleBtn=document.getElementById('toggleBtn');
    toggleBtn.onclick=()=>sheet.classList.toggle('open');
    const handle=document.getElementById('handle');let startY,origPerc=40;
    handle.addEventListener('pointerdown',e=>{startY=e.clientY;sheet.style.transition='none';window.addEventListener('pointermove',onDrag);window.addEventListener('pointerup',endDrag);});
    function onDrag(e){let dy=(e.clientY-startY)/window.innerHeight*100;let y=Math.min(Math.max(origPerc+dy,0),origPerc);sheet.style.transform=`translateY(${y}%)`}    
    function endDrag(e){let dy=(e.clientY-startY)/window.innerHeight*100;origPerc=Math.min(Math.max(origPerc+dy,0),origPerc);sheet.style.transition='transform .2s';sheet.style.transform=`translateY(${origPerc}%)`;window.removeEventListener('pointermove',onDrag);window.removeEventListener('pointerup',endDrag);}
    const originInput=document.getElementById('originInput'),editOriginBtn=document.getElementById('editOriginBtn');
    const addressInput=document.getElementById('addressInput'),addBtn=document.getElementById('addBtn'),routeBtn=document.getElementById('routeBtn'),listEl=document.getElementById('list');
    let myLoc,myMarker,routingControl;let addresses=JSON.parse(localStorage.getItem('addresses')||'[]'),markers=[];
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{myLoc=[p.coords.latitude,p.coords.longitude];fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${myLoc[0]}&lon=${myLoc[1]}&zoom=3`).then(r=>r.json()).then(d=>{if(d.boundingbox){const bb=d.boundingbox.map(parseFloat);map.fitBounds([[bb[0],bb[2]],[bb[1],bb[3]]]);}});setOrigin(myLoc,'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ');},e=>{originInput.value='ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';});}else originInput.value='Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹';
    function setOrigin(loc,label){originInput.value=label;if(myMarker)map.removeLayer(myMarker);myMarker=L.marker(loc,{draggable:true}).addTo(map).bindPopup(label).openPopup();myMarker.on('dragend',e=>{const p=e.target.getLatLng();myLoc=[p.lat,p.lng];});}
    editOriginBtn.onclick=()=>{const na=prompt('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©:',originInput.value);if(na)geocode(na,d=>setOrigin([+d.lat,+d.lon],na));};
    function geocode(addr,cb){fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`).then(r=>r.json()).then(a=>a[0]&&cb(a[0]));}
    function renderList(){listEl.innerHTML='';addresses.forEach((a,i)=>{const div=document.createElement('div');div.className='list-item';div.innerHTML=`<span>${a}</span><div><button class=\"edit-btn\" onclick=\"edit(${i})\">âœï¸</button><button class=\"delete-btn\" onclick=\"del(${i})\">ğŸ—‘ï¸</button></div>`;listEl.appendChild(div);});}
    window.del=i=>{addresses.splice(i,1);update();};window.edit=i=>{const na=prompt('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯:',addresses[i]);if(na){addresses[i]=na;update();}};
    function update(){localStorage.setItem('addresses',JSON.stringify(addresses));renderList();}
    addBtn.onclick=()=>{const a=addressInput.value.trim();if(!a)return;addresses.push(a);update();geocode(a,d=>{markers.push([+d.lat,+d.lon]);L.marker([+d.lat,+d.lon]).addTo(map).bindPopup(a);});addressInput.value='';};
    routeBtn.onclick=()=>{if(!myLoc||markers.length===0)return alert('Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ£Ø¶Ù Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹');if(routingControl)map.removeControl(routingControl);const w=[L.latLng(myLoc),...markers.map(m=>L.latLng(m))];routingControl=L.Routing.control({waypoints:w,lineOptions:{styles:[{color:'#38bdf8',weight:6}]},routeWhileDragging:false}).addTo(map);};
    addresses.forEach(a=>geocode(a,d=>{markers.push([+d.lat,+d.lon]);L.marker([+d.lat,+d.lon]).addTo(map).bindPopup(a);}));renderList();
  </script>
</body>
</html>
