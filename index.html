<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alwaki Route</title>
  <!-- Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø±Ø§Ø¦Ø· -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/leaflet-control-geocoder.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #fff;
      overflow: hidden;
      height: 100%;
    }
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    .left-bar {
      position: fixed;
      height: 35%;
      left: 0;
      top: 0;
      bottom: 0;
      width: 56px;
      background: #1e293b;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      z-index: 1001;
      box-shadow: 2px 0 4px rgba(0,0,0,0.3);
    }
    .left-bar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      padding: 10px;
      cursor: pointer;
      margin: 4px 0;
    }
    .left-bar button:hover {
      background: #334155;
      border-radius: 8px;
    }
    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 65%;
      background: #1e293b;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 15px;
      z-index: 1000;
      overflow-y: auto;
      transform: translateY(60%);
      transition: transform 0.3s ease;
      cursor: grab;
      touch-action: pan-y;
    }
    .bottom-sheet.open {
      transform: translateY(0);
    }
    .drag-handle {
      width: 40px;
      height: 5px;
      background: #4b5563;
      border-radius: 3px;
      margin: 0 auto 10px;
      cursor: grab;
    }
    .section {
      position: relative;
      margin-bottom: 8px;
    }
    .input-suggest {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #334155;
      color: #fff;
    }
    .suggestions ul {
      position: absolute;
      bottom: calc(100% + 2px);
      left: 0;
      right: 0;
      max-height: 140px;
      overflow-y: auto;
      background: #2a2a2a;
      border-radius: 8px;
      list-style: none;
      padding: 0;
      margin: 0;
      z-index: 1002;
      display: none;
    }
    .suggestions ul li {
      padding: 8px 12px;
      cursor: pointer;
      color: #eee;
    }
    .list-item {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      cursor: grab;
    }
    .list-item.drag-over {
      border: 2px dashed #10b981;
    }
    .list-item span {
      flex: 1;
      word-break: break-word;
      color: #ddd;
    }
    .list-item button {
      background: #ef4444;
      border: none;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      color: #fff;
      margin-right: 8px;
    }
    #addStopBtn {
      width: 100%;
      padding: 12px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #addStopBtn:hover {
      background: #0f9b6f;
    }
    .directions {
      flex: 1;
      overflow-y: auto;
      background: #24303d;
      border-radius: 8px;
      padding: 10px;
    }
    .directions li {
      padding: 8px;
      background: #334155;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
    }
    .leaflet-popup-content {
      text-align: right;
      direction: rtl;
    }
    .custom-marker {
      background: #334155;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
      min-width: 80px;
    }
    .origin-marker { background: #10b981 !important; }
    .stop-marker { background: #ef4444 !important; }
  </style>
</head>
<body>
  <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div id="map"></div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    <!-- Ø­Ù‚Ù„ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div class="section suggestions">
      <input id="originInput" class="input-suggest" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±)">
      <ul id="originSug"></ul>
    </div>
    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª -->
    <div class="list" id="stopsList"></div>
    <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø© -->
    <div class="section suggestions">
      <input id="stopInput" class="input-suggest" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø© ØªÙˆÙ‚Ù Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† ÙƒØ§Ù…Ù„">
      <ul id="stopSug"></ul>
    </div>
    <!-- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª -->
    <div class="directions" id="directionsPanel">
      <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø±Ø£Ø³ÙŠ -->
  <div class="left-bar">
    <button id="locationBtn" title="Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹"><i>ğŸ“</i></button>
    <div class="tooltip">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
    <button id="addStopBtn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©"><i>â•</i></button>
    <div class="tooltip">Ø£Ø¶Ù Ù…Ø­Ø·Ø©</div>
    <button id="saveRouteBtn" title="Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±"><i>ğŸ’¾</i></button>
    <div class="tooltip">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±</div>
    <button id="importGPXBtn" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ GPX"><i>ğŸ“‚</i></button>
    <div class="tooltip">Ø§Ø³ØªÙŠØ±Ø§Ø¯ GPX</div>
    <button id="exportGPXBtn" title="ØªØµØ¯ÙŠØ± GPX"><i>ğŸ“</i></button>
    <div class="tooltip">ØªØµØ¯ÙŠØ± GPX</div>
    <button id="shareRouteBtn" title="Ù…Ø´Ø§Ø±ÙƒØ©"><i>ğŸ”—</i></button>
    <div class="tooltip">Ù…Ø´Ø§Ø±ÙƒØ©</div>
    <button id="clearRouteBtn" title="Ù…Ø³Ø­"><i>ğŸ—‘ï¸</i></button>
    <div class="tooltip">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³Ø§Ø±</div>
  </div>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø®ÙØ§Ø¡ Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù GPX -->
  <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;">

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¢Ù…Ù†Ø©
      const map = L.map('map').setView([30.0444, 31.2357], 5); // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…ØµØ± Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // --- ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¨ÙˆØªÙˆÙ… Ø´ÙŠØª ---
      const sheet = document.getElementById('sheet');
      let startY, startT;

      sheet.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;

        startY = e.clientY;
        startT = parseInt(window.getComputedStyle(sheet).transform.split('(')[1].split('%')[0] || 60);
        sheet.style.transition = 'none';

        const onMouseMove = (e) => {
          const dy = (e.clientY - startY) * 0.6;
          const y = Math.min(Math.max(startT + dy, 0), 60);
          sheet.style.transform = `translateY(${y}%)`;
        };

        const onMouseUp = () => {
          if (startT < 30) sheet.classList.add('open');
          else sheet.classList.remove('open');
          sheet.style.transition = 'transform 0.3s';
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
        };

        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
      });

      // --- Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« ---
      const nominatimParams = 'format=json&addressdetails=1&accept-language=ar';
      let originCoords, originMarker, routingControl;
      let stops = JSON.parse(localStorage.getItem('stops') || '[]');
      let stopMarkers = [];

      // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ---
      function routeStops() {
        if (!originCoords || stops.length < 1) return;

        const waypoints = [
          L.latLng(originCoords),
          ...stops.map(s => L.latLng(s.lat, s.lon))
        ];

        if (waypoints.length < 2) return;

        if (routingControl) map.removeControl(routingControl);
        routingControl = L.Routing.control({
          waypoints: waypoints,
          lineOptions: { styles: [{ color: '#38bdf8', weight: 5 }] },
          router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1'
          }),
          formatter: new L.Routing.Formatter({ language: 'ar', units: 'metric' })
        }).addTo(map);

        routingControl.on('routesfound', (e) => {
          const dirList = document.getElementById('directionsList');
          dirList.innerHTML = '';
          e.routes[0].instructions.forEach(inst => {
            const li = document.createElement('li');
            li.innerHTML = `
              <span class="desc">${inst.text}</span>
              <span class="dist">${(inst.distance / 1000).toFixed(1)} ÙƒÙ…</span>
            `;
            dirList.appendChild(li);
          });
        });
      }

      // --- ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ IP ---
      async function setCountryFromIP() {
        try {
          const response = await fetch('https://ipapi.co/json/');
          const data = await response.json();
          if (data.latitude && data.longitude) {
            map.setView([data.latitude, data.longitude], 12);
            originInput.placeholder = `Ù…ÙˆÙ‚Ø¹Ùƒ ÙÙŠ ${data.region || data.country_name}`;
            originCoords = [data.latitude, data.longitude];
            setOrigin();
            routeStops();
          } else {
            map.setView([30.0444, 31.2357], 5);
          }
        } catch (error) {
          console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
          map.setView([30.0444, 31.2357], 5);
        }
      }

      // --- ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
      function setOrigin() {
        if (originMarker) map.removeLayer(originMarker);
        if (originCoords) {
          originMarker = L.marker(originCoords).addTo(map);
          map.setView(originCoords, 14);
        }
      }

      // --- ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª ---
      function updateStops() {
        const stopsList = document.getElementById('stopsList');
        stopsList.innerHTML = '';
        stopMarkers.forEach(marker => map.removeLayer(marker));
        stopMarkers = [];

        stops.forEach((s, i) => {
          const div = document.createElement('div');
          div.className = 'list-item';
          div.draggable = true;
          div.dataset.index = i;
          div.innerHTML = `<span>${s.name}</span><button onclick="delStop(${i})">ğŸ—‘ï¸</button>`;
          div.addEventListener('dragstart', e => e.dataTransfer.setData('text', i));
          div.addEventListener('dragover', e => {
            e.preventDefault();
            div.classList.add('drag-over');
          });
          div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
          div.addEventListener('drop', e => {
            const from = +e.dataTransfer.getData('text');
            stops.splice(i, 0, stops.splice(from, 1)[0]);
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            routeStops();
          });

          div.querySelector('span').onclick = () => {
            const newName = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©:', s.name);
            if (newName) {
              stops[i].name = newName;
              localStorage.setItem('stops', JSON.stringify(stops));
              updateStops();
              routeStops();
            }
          };

          stopsList.appendChild(div);
          const marker = L.marker([s.lat, s.lon], {
            icon: L.divIcon({
              className: 'custom-marker stop-marker',
              html: `<div>${s.name}</div>`,
              iconSize: [null, null],
              iconAnchor: [60, 15]
            })
          }).addTo(map);
          stopMarkers.push(marker);
        });
      }

      // --- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ---
      document.getElementById('locationBtn').addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
          return;
        }
        originInput.value = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ...';
        navigator.geolocation.getCurrentPosition(
          position => {
            originCoords = [position.coords.latitude, position.coords.longitude];
            originInput.value = 'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';
            setOrigin();
            routeStops();
            map.setView(originCoords, 14);
          },
          error => {
            console.warn('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
            originInput.placeholder = 'Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ø¶ØºØ· Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±)';
            setCountryFromIP();
          }
        );
      });

      document.getElementById('addStopBtn').addEventListener('click', () => {
        if (!originCoords) {
          alert('Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }
        const q = stopInput.value.trim();
        if (!q) return;
        fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=1`)
          .then(response => response.json())
          .then(data => {
            if (data[0]) {
              const name = prompt('Ø§Ø³Ù… Ù…Ø®ØµØµ:', data[0].display_name) || data[0].display_name;
              stops.push({ name, lat: data[0].lat, lon: data[0].lon });
              localStorage.setItem('stops', JSON.stringify(stops));
              updateStops();
              routeStops();
              stopInput.value = '';
            }
          });
      });

      // --- Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø± ---
      document.getElementById('saveRouteBtn').addEventListener('click', () => {
        const name = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±:');
        if (!name) return;
        const saved = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
        saved.push({ name, origin: originCoords, stops });
        localStorage.setItem('savedRoutes', JSON.stringify(saved));
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±');
      });

      // --- Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø³Ø§Ø± ---
      document.getElementById('shareRouteBtn').addEventListener('click', () => {
        if (!originCoords || stops.length === 0) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡');
        const routeData = { origin: originCoords, stops };
        const encoded = encodeURIComponent(JSON.stringify(routeData));
        const url = `${window.location.href.split('?')[0]}?route=${encoded}`;
        navigator.clipboard.writeText(url).then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·')).catch(() => prompt('Ø§Ù„Ø±Ø§Ø¨Ø·:', url));
      });

      // --- ØªØµØ¯ÙŠØ± GPX ---
      document.getElementById('exportGPXBtn').addEventListener('click', () => {
        if (!originCoords || stops.length === 0) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù„ØªØµØ¯ÙŠØ±Ù‡');
        const waypoints = stops.map((s, i) => ({
          lat: s.lat,
          lon: s.lon,
          name: s.name || `Ù…Ø­Ø·Ø© ${i+1}`
        }));
        const gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Alwaki Route" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>Ù…Ø³Ø§Ø± Ù…Ù† Alwaki Route</name>
    <time>${new Date().toISOString()}</time>
  </metadata>
${waypoints.map(w => `<wpt lat="${w.lat}" lon="${w.lon}"><name>${w.name}</name></wpt>`).join('')}
</gpx>`;
        const blob = new Blob([gpx], { type: 'text/xml' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `route-${Date.now()}.gpx`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      // --- Ø§Ø³ØªÙŠØ±Ø§Ø¯ GPX ---
      document.getElementById('importGPXBtn').addEventListener('click', () => {
        gpxFileInput.click();
      });
      document.getElementById('gpxFileInput').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const xmlDoc = new DOMParser().parseFromString(reader.result, "text/xml");
          const nodes = xmlDoc.querySelectorAll('wpt');
          stops = Array.from(nodes).map((node, i) => ({
            name: node.querySelector('name')?.textContent || `Ù…Ø­Ø·Ø© ${i+1}`,
            lat: node.getAttribute('lat'),
            lon: node.getAttribute('lon')
          }));
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
        };
        reader.readAsText(file);
      });

      // --- Ù…Ø³Ø­ Ø§Ù„Ù…Ø³Ø§Ø± ---
      document.getElementById('clearRouteBtn').addEventListener('click', () => {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŸ')) return;
        stops = [];
        originCoords = null;
        localStorage.removeItem('stops');
        updateStops();
        if (originMarker) map.removeLayer(originMarker);
        if (routingControl) map.removeControl(routingControl);
        document.getElementById('directionsList').innerHTML = '';
        setCountryFromIP();
      });

      // --- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
      document.getElementById('originInput').addEventListener('input', async (e) => {
        const q = e.target.value;
        if (q.length < 2) return;
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`);
          const data = await response.json();
          const originSug = document.getElementById('originSug');
          originSug.innerHTML = '';
          data.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p.display_name;
            li.onclick = () => {
              originInput.value = p.display_name;
              originCoords = [p.lat, p.lon];
              setOrigin();
              routeStops();
              originSug.style.display = 'none';
            };
            originSug.appendChild(li);
            originSug.style.display = 'block';
          });
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
        }
      });

      // --- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø§Øª ---
      document.getElementById('stopInput').addEventListener('input', async (e) => {
        const q = e.target.value;
        if (q.length < 2) return;
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`);
          const data = await response.json();
          const stopSug = document.getElementById('stopSug');
          stopSug.innerHTML = '';
          data.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p.display_name;
            li.onclick = () => {
              stops.push({ name: p.display_name, lat: p.lat, lon: p.lon });
              localStorage.setItem('stops', JSON.stringify(stops));
              updateStops();
              routeStops();
              stopInput.value = '';
              stopSug.style.display = 'none';
            };
            stopSug.appendChild(li);
            stopSug.style.display = 'block';
          });
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
        }
      });

      // --- Ø­Ø°Ù Ù…Ø­Ø·Ø© ---
      window.delStop = (index) => {
        stops.splice(index, 1);
        localStorage.setItem('stops', JSON.stringify(stops));
        updateStops();
        routeStops();
      };

      // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
      async function init() {
        await setCountryFromIP();
        updateStops();
        routeStops();
      }
      init();
    });
  </script>
</body>
</html>
