<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e293b">
  <title>Alwaki Route</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#fff;overflow:hidden}
    #map{position:absolute;top:0;left:0;right:0;bottom:0}
    .sheet-toggle{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:#10b981;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1001}
    .sheet-toggle i{color:#fff;font-size:1.5rem}
    .bottom-sheet{position:fixed;left:0;right:0;bottom:0;height:70%;background:rgba(30,30,30,0.95);backdrop-filter:blur(8px);border-top-left-radius:20px;border-top-right-radius:20px;padding:20px;display:none;flex-direction:column;z-index:1000;overflow:hidden;transform:translateY(100%);transition:transform .3s ease}
    .bottom-sheet.open{display:flex;transform:translateY(0)}
    .drag-handle{width:50px;height:5px;background:#4b5563;border-radius:3px;margin:0 auto 10px;cursor:grab}
    h2{text-align:center;margin-bottom:10px}
    .input-suggest{width:100%;margin-bottom:8px;padding:12px;border:none;border-radius:8px;font-size:1rem;background:#334155;color:#fff;position:relative}
    .suggestions ul{position:absolute;bottom:calc(100% + 2px);left:0;right:0;max-height:150px;overflow-y:auto;background:#1f2937;border-radius:8px;list-style:none;margin:0;padding:0;z-index:1002}
    .suggestions ul li{padding:10px;cursor:pointer}
    .suggestions ul li:hover{background:#4b5563}
    button{padding:12px;border:none;border-radius:8px;background:#10b981;color:#fff;font-size:1rem;cursor:pointer;margin-bottom:8px}
    .list{flex:1;overflow-y:auto;margin-bottom:8px}
    .list-item{background:#1f2937;padding:10px;border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
    .list-item span{flex:1;word-break:break-word}
    .list-item button{background:#ef4444;padding:6px;border:none;border-radius:6px;color:#fff;cursor:pointer}
    .route-btn{position:fixed;bottom:90px;right:30px;width:50px;height:50px;background:#38bdf8;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;cursor:pointer;z-index:1001}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="sheet-toggle" id="toggleBtn"><i>&#9776;</i></div>
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    <h2>Alwaki Route</h2>
    <div class="suggestions">
      <input id="originInput" class="input-suggest" placeholder="ŸÜŸÇÿ∑ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© (ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿßÿÆÿ™Ÿäÿßÿ±)">
      <ul id="originSug"></ul>
    </div>
    <div class="list" id="stopsList"></div>
    <div class="suggestions">
      <input id="stopInput" class="input-suggest" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ≠ÿ∑ÿ© ÿ™ŸàŸÇŸÅ">
      <ul id="stopSug"></ul>
    </div>
    <button id="addStopBtn">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿ∑ÿ© ÿ™ŸàŸÇŸÅ</button>
  </div>
  <div class="route-btn" id="routeBtn">üöó</div>
  <script>
    // Map and country view via IP-API
    const map=L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    fetch('https://ipapi.co/json/').then(r=>r.json()).then(d=>{map.setView([d.latitude,d.longitude],5)});

    // UI
    const sheet=document.getElementById('sheet'),toggleBtn=document.getElementById('toggleBtn'); toggleBtn.onclick=()=>sheet.classList.toggle('open');
    const handle=document.getElementById('handle'); handle.addEventListener('pointerdown',()=>{});

    const originInput=document.getElementById('originInput');
    const originSug=document.getElementById('originSug');
    const stopsList=document.getElementById('stopsList');
    const stopInput=document.getElementById('stopInput');
    const stopSug=document.getElementById('stopSug');
    const addStopBtn=document.getElementById('addStopBtn');
    const routeBtn=document.getElementById('routeBtn');

    let originCoords,originMarker;
    let stops=[],stopMarkers=[];
    let routingControl;

    // Origin suggestions and selection
    originInput.onclick=()=>originInput.value='', originSug.style.display='block';
    originInput.addEventListener('input',async()=>{
      const q=originInput.value; if(q.length<2){originSug.style.display='none';return;} originSug.innerHTML=''; originSug.style.display='block';
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`);
      const d=await res.json(); d.forEach(p=>{const li=document.createElement('li');li.textContent=p.display_name;li.onclick=()=>{originInput.value=p.display_name; originSug.style.display='none'; originCoords=[+p.lat,+p.lon]; setOrigin();};originSug.appendChild(li);});
    });
    document.body.addEventListener('click',e=>{if(!originInput.contains(e.target))originSug.style.display='none'});
    function setOrigin(){if(originMarker)map.removeLayer(originMarker);originMarker=L.marker(originCoords).addTo(map).bindPopup('ÿßŸÑÿ®ÿØÿßŸäÿ©').openPopup();map.setView(originCoords,14);}    

    // Stops suggestions
    stopInput.addEventListener('input',async()=>{
      const q=stopInput.value; if(q.length<2){stopSug.style.display='none';return;} stopSug.innerHTML=''; stopSug.style.display='block';
      const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`);
      const d=await res.json(); d.forEach(p=>{const li=document.createElement('li');li.textContent=p.display_name;li.onclick=()=>{stopInput.value=p.display_name; stopInput.dataset.lat=p.lat; stopInput.dataset.lon=p.lon; stopSug.style.display='none';};stopSug.appendChild(li);});
    });
    document.body.addEventListener('click',e=>{if(!stopInput.contains(e.target))stopSug.style.display='none'});

    // Add stop
    addStopBtn.onclick=()=>{
      const name=stopInput.value.trim(); const lat=stopInput.dataset.lat; const lon=stopInput.dataset.lon;
      if(!name||!lat) return;
      stops.push({name,lat:+lat,lon:+lon}); updateStops(); stopInput.value='';
    };
    function updateStops(){ stopsList.innerHTML=''; stops.forEach((s,i)=>{ const div=document.createElement('div'); div.className='list-item'; div.innerHTML=`<span>${s.name}</span><button onclick="delStop(${i})">üóëÔ∏è</button>`; div.querySelector('span').onclick=()=>editStop(i); stopsList.appendChild(div); });
      // markers
      stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[];
      stops.forEach(s=>{const m=L.marker([s.lat,s.lon]).addTo(map).bindPopup(s.name); stopMarkers.push(m);});
    }
    window.delStop=i=>{stops.splice(i,1);updateStops();}; function editStop(i){const na=prompt('ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≠ÿ∑ÿ©:',stops[i].name); if(na){stops[i].name=na; updateStops();}};

    // Routing
    routeBtn.onclick=()=>{ if(!originCoords||stops.length===0) return; if(routingControl)map.removeControl(routingControl);
      const wpts=[L.latLng(originCoords),...stops.map(s=>L.latLng(s.lat,s.lon))]; routingControl=L.Routing.control({waypoints:wpts,lineOptions:{styles:[{color:'#38bdf8',weight:6}]},routeWhileDragging:false}).addTo(map);
    };

  </script>
</body>
</html>
