<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Alwaki Route</title>
  <!-- Ù…ÙƒØªØ¨Ø© Leaflet Ù„Ù„Ø®Ø±Ø§Ø¦Ø· -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <!-- CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Leaflet Routing Machine -->
  <link href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" rel="stylesheet">
  <!-- CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ Geocoder -->
  <link href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a; color: #fff;
      overflow: hidden; height: 100%;
    }
    #map {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1;
    }
    .left-bar {
      position: fixed; height: 35%; left: 0; top: 0; width: 56px;
      background: #1e293b; display: flex; flex-direction: column;
      align-items: center; padding: 12px 0; z-index: 1001;
      box-shadow: 2px 0 4px rgba(0,0,0,0.3);
    }
    .left-bar button {
      background: none; border: none; color: #fff;
      font-size: 20px; padding: 10px; cursor: pointer; margin: 4px 0;
    }
    .left-bar button:hover { background: #334155; border-radius: 8px; }
    .left-bar .tooltip {
      position: fixed; right: 60px; background: #334155;
      padding: 6px 12px; border-radius: 6px;
      white-space: nowrap; opacity: 0; transition: opacity 0.3s;
      pointer-events: none; font-size: 14px; z-index: 1002;
    }
    .left-bar button:hover + .tooltip { opacity: 1; }

    .bottom-sheet {
      position: fixed; left: 0; right: 0; bottom: 0; height: 65%;
      background: #1e293b; border-top-left-radius: 20px;
      border-top-right-radius: 20px; padding: 15px; z-index: 1000;
      overflow-y: auto; transform: translateY(60%);
      transition: transform 0.3s ease;
    }
    .bottom-sheet.open { transform: translateY(0); }
    .drag-handle {
      width: 40px; height: 5px; background: #4b5563;
      border-radius: 3px; margin: 0 auto 10px; cursor: grab;
    }
    .section { position: relative; margin-bottom: 8px; }
    .input-suggest {
      width: 100%; padding: 10px; border: none;
      border-radius: 8px; font-size: 1rem;
      background: #334155; color: #fff;
    }
    .suggestions ul {
      position: absolute; bottom: calc(100% + 2px);
      left: 0; right: 0; max-height: 140px; overflow-y: auto;
      background: #2a2a2a; border-radius: 8px;
      list-style: none; padding: 0; margin: 0;
      z-index: 1002; display: none;
    }
    .suggestions ul li {
      padding: 8px 12px; cursor: pointer; color: #eee;
    }
    .suggestions ul li:hover { background: #555; }

    .list {
      flex: 1; overflow-y: auto; margin-bottom: 8px;
    }
    .list-item {
      background: #2a2a2a; padding: 8px; border-radius: 8px;
      margin-bottom: 6px; display: flex; align-items: center;
      cursor: grab;
    }
    .list-item.drag-over { border: 2px dashed #10b981; }
    .list-item span {
      flex: 1; word-break: break-word; color: #ddd;
    }
    .list-item button {
      background: #ef4444; border: none; border-radius: 6px;
      padding: 6px; cursor: pointer; color: #fff; margin-right: 8px;
    }

    #addStopBtn {
      width: 100%; padding: 12px; background: #10b981;
      color: #fff; border: none; border-radius: 8px;
      font-size: 1rem; cursor: pointer; margin-bottom: 8px;
      display: flex; align-items: center; justify-content: center;
    }
    #addStopBtn:hover { background: #0f9b6f; }
    #addStopBtn i { margin-left: 8px; }

    .directions {
      flex: 1; overflow-y: auto; background: #24303d;
      border-radius: 8px; padding: 10px;
    }
    .directions h3 {
      font-size: 1rem; margin-bottom: 8px;
      text-align: center; color: #fff;
    }
    .directions ol {
      list-style: none; padding-left: 0;
    }
    .directions li {
      padding: 8px; background: #334155;
      border-radius: 6px; margin-bottom: 6px;
      display: flex; align-items: center;
    }
    .directions li .desc {
      flex: 1; color: #e0e0e0;
    }
    .directions li .dist {
      margin-left: 8px; color: #bbb; font-size: 0.9rem;
      white-space: nowrap;
    }

    .leaflet-popup-content { text-align: right; direction: rtl; }
    .leaflet-control-container .leaflet-routing-container {
      font-family: 'Segoe UI', sans-serif; direction: rtl;
      text-align: right;
    }

    .custom-marker {
      background: #334155; color: #fff;
      padding: 4px 8px; border-radius: 4px;
      font-size: 12px; text-align: center;
      min-width: 80px;
    }
    .origin-marker { background: #10b981 !important; }
    .stop-marker   { background: #ef4444 !important; }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <div class="left-bar">
    <button id="locationBtn" title="Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹"><i>ğŸ“</i></button><div class="tooltip">Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
    <button id="addStopBtn"       title="Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø·Ø©"><i>â•</i></button><div class="tooltip">Ø£Ø¶Ù Ù…Ø­Ø·Ø©</div>
    <button id="saveRouteBtn"     title="Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±"><i>ğŸ’¾</i></button><div class="tooltip">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±</div>
    <button id="importGPXBtn"     title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ GPX"><i>ğŸ“‚</i></button><div class="tooltip">Ø§Ø³ØªÙŠØ±Ø§Ø¯ GPX</div>
    <button id="exportGPXBtn"     title="ØªØµØ¯ÙŠØ± GPX"><i>ğŸ“</i></button><div class="tooltip">ØªØµØ¯ÙŠØ± GPX</div>
    <button id="shareRouteBtn"    title="Ù…Ø´Ø§Ø±ÙƒØ©"><i>ğŸ”—</i></button><div class="tooltip">Ù…Ø´Ø§Ø±ÙƒØ©</div>
    <button id="clearRouteBtn"    title="Ù…Ø³Ø­"><i>ğŸ—‘ï¸</i></button><div class="tooltip">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³Ø§Ø±</div>
  </div>

  <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div id="map"></div>

  <!-- ØªØ­Ù…ÙŠÙ„ GPX -->
  <input type="file" id="gpxFileInput" accept=".gpx" style="display:none;">

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>

    <!-- Ø­Ù‚Ù„ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div class="section suggestions">
      <input id="originInput" class="input-suggest" placeholder="Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©">
      <ul id="originSug"></ul>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª -->
    <div class="list" id="stopsList"></div>

    <!-- Ø­Ù‚Ù„ Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø·Ø§Øª -->
    <div class="section suggestions">
      <input id="stopInput" class="input-suggest" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø·Ø© ØªÙˆÙ‚Ù">
      <ul id="stopSug"></ul>
    </div>

    <!-- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª -->
    <div class="directions">
      <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
    const map = L.map('map').setView([0,0],2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const nominatimParams = 'format=json&addressdetails=1&accept-language=ar';
    let originCoords    = null,
        originMarker    = null,
        routingControl  = null,
        stops            = JSON.parse(localStorage.getItem('stops') || '[]'),
        stopMarkers      = [],
        userCountry      = '',
        userCity         = '';

    // --- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ù„Ø¯ ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù…Ù† IP ---
    async function setCountryFromIP(){
      try {
        const res  = await fetch('https://ipapi.co/json/');
        const data = await res.json();
        userCountry = data.country_name || '';
        userCity    = data.city || data.region || '';
        if(data.latitude && data.longitude){
          originCoords = [data.latitude, data.longitude];
          setOrigin();
          routeStops();
        }
      } catch {}
    }

    // --- Ø¶Ø¨Ø· Ù…Ø§Ø±ÙƒØ± Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ---
    function setOrigin(){
      if(originMarker) map.removeLayer(originMarker);
      if(originCoords){
        originMarker = L.marker(originCoords, {
          icon: L.divIcon({
            className: 'custom-marker origin-marker',
            html: `<div>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>`
          })
        }).addTo(map);
        map.setView(originCoords,14);
      }
    }

    // --- ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª ÙˆØ±Ø³Ù… Ù…Ø§Ø±ÙƒØ±Ø§ØªÙ‡Ø§ ---
    function updateStops(){
      stopsList.innerHTML = '';
      stopMarkers.forEach(m=>map.removeLayer(m));
      stopMarkers = [];
      stops.forEach((s,i)=>{
        const div = document.createElement('div');
        div.className     = 'list-item';
        div.draggable     = true;
        div.dataset.index = i;
        div.innerHTML     = `<span>${s.name}</span><button onclick="delStop(${i})">ğŸ—‘ï¸</button>`;

        div.addEventListener('dragstart', e => e.dataTransfer.setData('text', i));
        div.addEventListener('dragover',  e => { e.preventDefault(); div.classList.add('drag-over'); });
        div.addEventListener('dragleave', ()=> div.classList.remove('drag-over'));
        div.addEventListener('drop', e => {
          e.preventDefault(); div.classList.remove('drag-over');
          const from = +e.dataTransfer.getData('text');
          stops.splice(i,0,stops.splice(from,1)[0]);
          localStorage.setItem('stops',JSON.stringify(stops));
          updateStops(); routeStops();
        });

        div.querySelector('span').onclick = () => {
          const name = prompt('ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø·Ø©:', s.name);
          if(name){
            stops[i].name = name;
            localStorage.setItem('stops',JSON.stringify(stops));
            updateStops(); routeStops();
          }
        };

        stopsList.appendChild(div);

        const m = L.marker([s.lat, s.lon], {
          icon: L.divIcon({
            className: 'custom-marker stop-marker',
            html: `<div>${s.name}</div>`
          })
        }).addTo(map);
        stopMarkers.push(m);
      });
    }

    // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆÙˆØ¸Ø§Ø¦ÙÙ‡Ø§ ---
    function setupButtonEvents(){
      locationBtn.addEventListener('click', ()=>{
        if(!navigator.geolocation) return alert('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
        navigator.geolocation.getCurrentPosition(pos=>{
          originCoords = [pos.coords.latitude, pos.coords.longitude];
          setOrigin(); routeStops();
        }, ()=> setCountryFromIP(),{enableHighAccuracy:true,timeout:5000});
      });

      originInput.addEventListener('input', async e=>{
        const q = e.target.value, sug = originSug;
        if(q.length<2) return sug.style.display='none';
        const res = await fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`);
        const data = await res.json();
        sug.innerHTML=''; sug.style.display='block';
        data.forEach(p=>{
          const label = userCountry && userCity
            ? `${userCountry}, ${userCity} â€” ${p.display_name}`
            : p.display_name;
          const li = document.createElement('li');
          li.textContent = label;
          li.onclick = ()=>{
            originCoords = [+p.lat, +p.lon];
            setOrigin(); routeStops();
            originInput.value = p.display_name;
            sug.style.display = 'none';
          };
          sug.appendChild(li);
        });
      });

      stopInput.addEventListener('input', async e=>{
        const q = e.target.value, sug = stopSug;
        if(q.length<2) return sug.style.display='none';
        const res = await fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=5`);
        const data = await res.json();
        sug.innerHTML=''; sug.style.display='block';
        data.forEach(p=>{
          const label = userCountry && userCity
            ? `${userCountry}, ${userCity} â€” ${p.display_name}`
            : p.display_name;
          const li = document.createElement('li');
          li.textContent = label;
          li.onclick = ()=>{
            const name = prompt('Ø§Ø³Ù… Ù…Ø®ØµØµ:', p.display_name) || p.display_name;
            if(stops.some(s=>s.name===name)) return alert('Ø§Ù„Ù…Ø­Ø·Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©');
            stops.push({ name, lat:+p.lat, lon:+p.lon });
            localStorage.setItem('stops',JSON.stringify(stops));
            updateStops(); routeStops();
            stopInput.value = '';
            sug.style.display='none';
          };
          sug.appendChild(li);
        });
      });

      addStopBtn.addEventListener('click', ()=> stopInput.dispatchEvent(new Event('input')));

      saveRouteBtn.addEventListener('click', ()=>{
        if(!originCoords && !stops.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù„Ù„Ø­ÙØ¸');
        const name = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±:');
        if(!name) return;
        const arr = JSON.parse(localStorage.getItem('savedRoutes')||'[]');
        arr.push({ name, origin: originCoords, stops });
        localStorage.setItem('savedRoutes', JSON.stringify(arr));
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø±');
      });

      importGPXBtn.addEventListener('click', ()=> gpxFileInput.click());
      gpxFileInput.addEventListener('change', e=>{
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          const xml = new DOMParser().parseFromString(reader.result,'text/xml');
          const wpts = xml.getElementsByTagName('wpt');
          if(!wpts.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ù…Ù„Ù');
          stops = [];
          for(let i=0; i<wpts.length; i++){
            const n = wpts[i];
            stops.push({
              name: n.getElementsByTagName('name')[0]?.textContent||`Ù…Ø­Ø·Ø© ${i+1}`,
              lat: parseFloat(n.getAttribute('lat')),
              lon: parseFloat(n.getAttribute('lon'))
            });
          }
          localStorage.setItem('stops',JSON.stringify(stops));
          updateStops(); routeStops();
          alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${stops.length} Ù†Ù‚Ø·Ø©`);
        };
        reader.onerror = ()=> alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© GPX');
        reader.readAsText(file);
      });

      exportGPXBtn.addEventListener('click', ()=>{
        if(!stops.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ù„Ù„ØªØµØ¯ÙŠØ±');
        let gpx = `<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="Alwaki Route"><metadata><time>${new Date().toISOString()}</time></metadata>`;
        stops.forEach(s=>{
          gpx += `<wpt lat="${s.lat}" lon="${s.lon}"><name>${s.name}</name></wpt>`;
        });
        gpx += `</gpx>`;
        const blob = new Blob([gpx],{type:'application/gpx+xml'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url; a.download = `route-${Date.now()}.gpx`;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a); URL.revokeObjectURL(url);
      });

      shareRouteBtn.addEventListener('click', ()=>{
        if(!originCoords || !stops.length) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø± Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
        const data = { origin: originCoords, stops: stops.map(s=>[s.lat,s.lon]) };
        const url  = `${location.origin+location.pathname}?route=${encodeURIComponent(JSON.stringify(data))}`;
        navigator.clipboard?.writeText(url).then(()=>alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·')).catch(()=>prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:',url));
      });

      clearRouteBtn.addEventListener('click', ()=>{
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ')) return;
        stops = []; originCoords = null;
        localStorage.removeItem('stops');
        if(originMarker) map.removeLayer(originMarker);
        if(routingControl) map.removeControl(routingControl);
        directionsList.innerHTML = '';
      });
    }

    // --- Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRMv1 ---
    function routeStops(){
      if(!originCoords || stops.length<1){
        if(routingControl) map.removeControl(routingControl);
        return;
      }
      if(routingControl) map.removeControl(routingControl);

      const waypoints = [ L.latLng(originCoords), ...stops.map(s=>L.latLng(s.lat,s.lon)) ];
      const router    = new L.Routing.OSRMv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile:    'driving'
      }); // Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRMv1 Ø§Ù„ØµØ­ÙŠØ­

      routingControl = L.Routing.control({
        waypoints: waypoints,
        router:    router,
        lineOptions:{ styles: [{ weight: 5 }] },
        showAlternatives: false,
        formatter: new L.Routing.Formatter({ language:'ar', units:'metric' })
      }).addTo(map);

      routingControl.on('routingerror', err=>{
        console.error('Routing error:', err);
        alert('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.');
      });
    }

    window.delStop = i=>{
      stops.splice(i,1);
      localStorage.setItem('stops',JSON.stringify(stops));
      updateStops(); routeStops();
    };

    // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    window.onload = ()=>{
      setCountryFromIP();
      updateStops();
      setupButtonEvents();
      routeStops();
    };
  </script>
</body>
</html>
