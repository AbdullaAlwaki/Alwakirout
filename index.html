<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø®Ø±ÙŠØ·Ø© Ù…Ø¬Ø§Ù†ÙŠØ© - Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙˆÙƒÙŠÙ†</title>
  <!-- Leaflet CSS Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù…Ù† CDN -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-uQ5XH1YyMnx61o4iR+IaF+Ehc2k46kYp1m0G6o4xr14="
    crossorigin=""
  />
  <!-- Geocoder CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { position:absolute; top:0; bottom:0; right:0; left:250px; }
    #sidebar {
      position: absolute; top:0; bottom:0; left:0; width:250px;
      background:#fafafa; border-left:1px solid #ccc;
      overflow:auto; padding:10px; box-sizing:border-box;
    }
    #sidebar h2 { margin-top:0; font-size:1.2em; }
    ul { list-style:none; padding:0; }
    li { margin:5px 0; cursor:pointer; color:#007aff; }
    li:hover { text-decoration:underline; }
    .leaflet-control-geocoder-icon { background-image: none; }
    .locate-btn {
      background: white; border:1px solid #ccc; border-radius:4px;
      padding:6px; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,0.3);
    }
    .locate-btn:hover { background:#eee; }
  </style>
</head>
<body>

<div id="sidebar">
  <h2>ğŸ” Ø¨Ø­Ø«</h2>
  <div id="geocoder"></div>

  <h2>â­ Ù…ÙØ¶Ù„Ø§Øª</h2>
  <ul id="favorites"></ul>

  <h2>ğŸ•‘ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø£Ø®ÙŠØ±</h2>
  <ul id="recents"></ul>
</div>
<div id="map"></div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
  integrity="sha256-p3x0VCj0uUHeNIg1E0t59gRSlBMOZc8DRFQ5w5TttyM="
  crossorigin=""
></script>
<!-- Geocoder plugin -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
  // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  var map = L.map('map').setView([31.7917, 35.2170], 6); // Ù…Ø±ÙƒØ² Ø£ÙˆÙ„ÙŠ: Ø§Ù„Ø£Ø±Ø¯Ù†

  // Ø·Ø¨Ù‚Ø© OpenStreetMap Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
  var locateBtn = L.control({position:'topright'});
  locateBtn.onAdd = function(){
    var div = L.DomUtil.create('div','locate-btn');
    div.title = 'Ù…ÙˆÙ‚Ø¹ÙŠ';
    div.innerHTML = 'ğŸ“';
    div.onclick = function(){
      map.locate({setView:true, maxZoom:16});
    };
    return div;
  };
  locateBtn.addTo(map);
  map.on('locationfound', function(e){
    L.circle(e.latlng, {radius:e.accuracy/2, color:'#136AEC'}).addTo(map);
    L.marker(e.latlng).addTo(map);
  });

  // Ø¥Ø¶Ø§ÙØ© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¨Ø­Ø« (Nominatim Ù…Ø¬Ø§Ù†ÙŠ)
  var geocoder = L.Control.geocoder({
    defaultMarkGeocode: false,
    placeholder: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†...'
  })
    .on('markgeocode', function(e){
      var c = e.geocode.center;
      map.setView(c, 15);

      // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª
      var marker = L.marker(c).addTo(map)
        .bindPopup(
          '<b>'+e.geocode.name+'</b><br/>' +
          '<button onclick="saveFavorite('+c.lat+','+c.lng+',\''+e.geocode.name.replace(/'/g,"\\'")+'\')">â˜… Ù…ÙØ¶Ù„Ø©</button> ' +
          '<button onclick="getDirections('+c.lat+','+c.lng+')">ğŸ—º Ø§ØªØ¬Ø§Ù‡</button>'
        )
        .openPopup();

      addRecent(e.geocode.name, c);
    })
    .addTo(map);

  // Ù†Ù‚Ù„ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
  document.getElementById('geocoder')
    .appendChild(geocoder.getContainer());

  // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
  var recentsKey = 'map_recents';
  var favsKey    = 'map_favorites';

  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„Ø±Ø³Ù…
  function loadList(key){
    return JSON.parse(localStorage.getItem(key) || '[]');
  }
  function saveList(key, arr){
    localStorage.setItem(key, JSON.stringify(arr));
  }
  function renderList(id, key, onClick){
    var ul = document.getElementById(id);
    ul.innerHTML = '';
    loadList(key).forEach(function(item){
      var li = document.createElement('li');
      li.textContent = item.name;
      li.onclick = function(){ onClick(item); };
      ul.appendChild(li);
    });
  }

  function addRecent(name, center){
    var rec = loadList(recentsKey)
      .filter(r=>r.name!==name);
    rec.unshift({name:name, lat:center.lat, lng:center.lng});
    if(rec.length>5) rec.pop();
    saveList(recentsKey, rec);
    renderList('recents', recentsKey, item=>map.setView([item.lat,item.lng],15));
  }
  function saveFavorite(lat, lng, name){
    var fav = loadList(favsKey);
    if(!fav.find(f=>f.name===name)){
      fav.push({name:name, lat:lat, lng:lng});
      saveList(favsKey, fav);
      renderList('favorites', favsKey, item=>map.setView([item.lat,item.lng],15));
    }
  }
  function getDirections(lat, lng){
    // Ø±Ø§Ø¨Ø· Ø§ØªØ¬Ø§Ù‡Ø§Øª Google Ù…Ø¬Ø§Ù†ÙŠ ÙˆÙ„Ø§ ÙŠØ­ØªØ§Ø¬ API ØªÙˆÙƒÙŠÙ† Ù„Ù„ÙØªØ­ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
    var url = 'https://www.google.com/maps/dir/?api=1&destination='+lat+','+lng;
    window.open(url, '_blank');
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  renderList('recents', recentsKey, item=>map.setView([item.lat,item.lng],15));
  renderList('favorites', favsKey, item=>map.setView([item.lat,item.lng],15));

</script>
</body>
</html>
