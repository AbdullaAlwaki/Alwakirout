<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Alwaki Route</title>
  <!-- Leaflet Map Library -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <!-- Geocoding Library -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/leaflet-control-geocoder.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #fff;
      overflow: hidden;
      height: 100%;
    }
    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    /* Vertical icon bar on the left */
    .left-bar {
      position: fixed;
      height: 35%;
      left: 0;
      top: 0;
      bottom: 0;
      width: 56px;
      background: #1e293b;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      z-index: 1001;
      box-shadow: 2px 0 4px rgba(0,0,0,0.3);
    }
    .left-bar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      padding: 10px;
      cursor: pointer;
      margin: 4px 0;
    }
    .left-bar button:hover {
      background: #334155;
      border-radius: 8px;
    }
    .left-bar .tooltip {
      position: fixed;
      right: 60px;
      background: #334155;
      padding: 6px 12px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      font-size: 14px;
      z-index: 1002;
    }
    .left-bar button:hover + .tooltip {
      opacity: 1;
    }
    /* Bottom sheet */
    .bottom-sheet {
      position: fixed;
      left: 0px;
      right: 0;
      bottom: 0;
      height: 65%;
      background: #1e293b;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 15px;
      z-index: 1000;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    .bottom-sheet.open {
      transform: translateY(0);
    }
    /* Improved drag handle */
    .drag-handle {
      width: 60px;  /* Increased from 40px */
      height: 8px;  /* Increased from 5px */
      background: #4b5563;
      border-radius: 4px;
      margin: 0 auto 12px;
      touch-action: pan-y;
      cursor: grab;
    }
    /* Toggle button for bottom sheet */
    #toggleSheet {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: #334155;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      color: #fff;
      cursor: pointer;
      z-index: 1003;
      font-size: 1.2em;
    }
    /* Status indicator */
    .status-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9rem;
      display: none;
    }
    .section {
      position: relative;
      margin-bottom: 8px;
    }
    .input-suggest {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #334155;
      color: #fff;
    }
    .suggestions ul {
      position: absolute;
      bottom: calc(100% + 2px);
      left: 0;
      right: 0;
      max-height: 140px;
      overflow-y: auto;
      background: #2a2a2a;
      border-radius: 8px;
      list-style: none;
      padding: 0;
      margin: 0;
      z-index: 1002;
      display: none;
    }
    .suggestions ul li {
      padding: 8px 12px;
      cursor: pointer;
      color: #eee;
    }
    .suggestions ul li:hover {
      background: #555;
    }
    .list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 8px;
    }
    .list-item {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      cursor: grab;
    }
    .list-item.drag-over {
      border: 2px dashed #10b981;
    }
    .list-item span {
      flex: 1;
      word-break: break-word;
      color: #ddd;
    }
    .list-item button {
      background: #ef4444;
      border: none;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      color: #fff;
      margin-right: 8px;
    }
    #addStopBtn {
      width: 100%;
      padding: 12px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #addStopBtn:hover {
      background: #0f9b6f;
    }
    #addStopBtn i {
      margin-left: 8px;
    }
    .directions {
      flex: 1;
      overflow-y: auto;
      background: #24303d;
      border-radius: 8px;
      padding: 10px;
    }
    .directions h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: #fff;
    }
    .directions ol {
      list-style: none;
      padding-left: 0;
    }
    .directions li {
      padding: 8px;
      background: #334155;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
    }
    .directions li span.desc {
      flex: 1;
      color: #e0e0e0;
    }
    .directions li span.dist {
      margin-left: 8px;
      color: #bbb;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    .leaflet-popup-content {
      text-align: right;
      direction: rtl;
    }
    .leaflet-control-container .leaflet-routing-container {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      text-align: right;
    }
    /* Custom marker styles */
    .custom-marker {
      background: #334155;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      text-align: center;
      min-width: 80px;
    }
    .origin-marker { background: #10b981 !important; }
    .stop-marker { background: #ef4444 !important; }
  </style>
</head>
<body>
  <!-- Vertical Icon Bar -->
  <div class="left-bar">
    <button id="locationBtn" title="الحصول على الموقع"><i>📍</i></button>
    <div class="tooltip">الحصول على الموقع</div>
    <button id="addStopBtn" title="إضافة محطة"><i>➕</i></button>
    <div class="tooltip">أضف محطة</div>
    <button id="saveRouteBtn" title="حفظ المسار"><i>💾</i></button>
    <div class="tooltip">حفظ المسار</div>
    <button id="importGPXBtn" title="استيراد GPX"><i>📂</i></button>
    <div class="tooltip">استيراد GPX</div>
    <button id="exportGPXBtn" title="تصدير GPX"><i>📁</i></button>
    <div class="tooltip">تصدير GPX</div>
    <button id="shareRouteBtn" title="مشاركة"><i>🔗</i></button>
    <div class="tooltip">مشاركة</div>
    <button id="clearRouteBtn" title="مسح"><i>🗑️</i></button>
    <div class="tooltip">مسح المسار</div>
  </div>
  
  <!-- Map -->
  <div id="map"></div>
  
  <!-- GPX File Upload -->
  <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;">
  
  <!-- Bottom Sheet -->
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    <!-- Toggle Button -->
    <button id="toggleSheet">≡</button>
    <!-- Origin Input -->
    <div class="section suggestions">
      <input id="originInput" class="input-suggest" placeholder="نقطة البداية (اضغط للاختيار)">
      <ul id="originSug"></ul>
    </div>
    <!-- Stop List -->
    <div class="list" id="stopsList"></div>
    <!-- Stop Search -->
    <div class="section suggestions">
      <input id="stopInput" class="input-suggest" placeholder="ابحث عن محطة توقف أو عنوان كامل">
      <ul id="stopSug"></ul>
    </div>
    <!-- Directions -->
    <div class="directions" id="directionsPanel">
      <h3>خطوات الاتجاهات</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>
  
  <!-- Status Indicator -->
  <div class="status-indicator" id="statusIndicator"></div>
  
  <script>
    // --- Map Setup ---
    const map = L.map('map').setView([0, 0], 2); // Will be updated later
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    
    // --- UI Elements ---
    const sheet = document.getElementById('sheet');
    const handle = document.getElementById('handle');
    const originInput = document.getElementById('originInput');
    const stopsList = document.getElementById('stopsList');
    const stopInput = document.getElementById('stopInput');
    const originSug = document.getElementById('originSug');
    const stopSug = document.getElementById('stopSug');
    const statusIndicator = document.getElementById('statusIndicator');
    
    // --- App State ---
    let originCoords, originMarker, routingControl;
    let stops = JSON.parse(localStorage.getItem('stops') || '[]');
    let stopMarkers = [];
    
    // --- Improved Slider/Bottom Sheet Functionality ---
    function setupBottomSheet() {
      // Enhanced drag functionality
      handle.addEventListener('pointerdown', e => {
        let startY = e.clientY;
        let startT = 100;
        
        sheet.style.transition = 'none';
        
        const onDrag = e2 => {
          let dy = (e2.clientY - startY)/window.innerHeight*100;
          let y = Math.min(Math.max(startT + dy, 0), 100);
          sheet.style.transform = `translateY(${y}%)`;
        };
        
        const onEnd = e2 => {
          let dy = (e2.clientY - startY)/window.innerHeight*100;
          startT = Math.min(Math.max(startT + dy, 0), 100);
          
          sheet.style.transition = 'transform .3s';
          sheet.style.transform = `translateY(${startT}%)`;
          
          // Update open state based on position
          if (startT < 50) {
            sheet.classList.add('open');
          } else {
            sheet.classList.remove('open');
          }
          
          window.removeEventListener('pointermove', onDrag);
          window.removeEventListener('pointerup', onEnd);
        };
        
        window.addEventListener('pointermove', onDrag);
        window.addEventListener('pointerup', onEnd);
      });
      
      // Toggle sheet on click
      if (handle) {
        handle.addEventListener('click', () => {
          sheet.classList.toggle('open');
        });
      }
      
      // Toggle sheet on button click
      const toggleSheetButton = document.getElementById('toggleSheet');
      if (toggleSheetButton) {
        toggleSheetButton.addEventListener('click', () => {
          sheet.classList.toggle('open');
        });
      }
    }
    
    // --- Improved Route Calculation with Error Handling ---
    function routeStops() {
      if (!originCoords || stops.length < 1) {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        document.getElementById('directionsList').innerHTML = '';
        return;
      }
      
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      const waypoints = [
        L.latLng(originCoords),
        ...stops.map(s => L.latLng(s.lat, s.lon))
      ];
      
      if (waypoints.length < 2) return;
      
      // Show loading indicator
      showStatus('جاري حساب المسار...');
      
      // Create router with proper configuration
      const router = new L.Routing.OSRMv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile: 'driving'
      });
      
      // Create routing control
      routingControl = L.Routing.control({
        waypoints: waypoints,
        router: router,
        lineOptions: { 
          styles: [{ 
            color: '#38bdf8', 
            weight: 5 
          }] 
        },
        showAlternatives: false,
        formatter: new L.Routing.Formatter({ language: 'ar', units: 'metric' }),
        routeWhileDragging: true,
        autoRoute: true
      }).addTo(map);
      
      // Handle route found
      routingControl.on('routesfound', e => {
        hideStatus();
        const routes = e.routes;
        const dirList = document.getElementById('directionsList');
        dirList.innerHTML = '';
        
        if (!routes || routes.length === 0) {
          dirList.innerHTML = '<li>لم يتم العثور على مسار</li>';
          return;
        }
        
        routes[0].instructions.forEach(inst => {
          const li = document.createElement('li');
          li.innerHTML = `
            <span class="desc">${inst.text}</span>
            <span class="dist">${(inst.distance / 1000).toFixed(1)} كم</span>
          `;
          dirList.appendChild(li);
        });
        
        // Fit map to route bounds
        if (routes[0].coordinates && routes[0].coordinates.length > 0) {
          const bounds = L.latLngBounds(routes[0].coordinates.map(coord => 
            L.latLng(coord.lat, coord.lng)
          ));
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      });
      
      // Handle routing errors
      routingControl.on('error', e => {
        hideStatus();
        console.error('Routing error:', e.message);
        alert('عذراً، لا يمكن حساب المسار حالياً. تأكد من اتصال الإنترنت.');
      });
      
      // Handle route calculation start
      routingControl.on('routeselected', () => {
        showStatus('جارٍ حساب المسار...');
      });
    }
    
    // --- Status Indicator Functions ---
    function showStatus(message) {
      statusIndicator.textContent = message;
      statusIndicator.style.display = 'block';
    }
    
    function hideStatus() {
      statusIndicator.style.display = 'none';
    }
    
    // --- Initialize the bottom sheet functionality ---
    function initDragHandleAndToggle() {
      // Add toggle button if it doesn't exist
      if (!document.getElementById('toggleSheet')) {
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'toggleSheet';
        toggleBtn.textContent = '≡';
        toggleBtn.style = `
          position: absolute;
          top: 8px;
          left: 50%;
          transform: translateX(-50%);
          background: #334155;
          border: none;
          padding: 4px 8px;
          color: #fff;
          cursor: pointer;
          border-radius: 4px;
          z-index: 1003;
          font-size: 1.2em;
        `;
        sheet.appendChild(toggleBtn);
      }
      
      // Initialize bottom sheet functionality
      setupBottomSheet();
    }
    
    // --- Map Setup ---
    const map = L.map('map').setView([0, 0], 2); // Will be updated later
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);
    
    // --- Initialize the bottom sheet functionality ---
    initDragHandleAndToggle();
    
    // --- Initialize route calculation ---
    routeStops();
  </script>
</body>
</html>
