<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1e293b" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-192.png" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
  
  <!-- Leaflet & Plugins -->
  <link 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    rel="stylesheet" 
  />
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" 
  />
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" 
  />
  <script 
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>
  <script 
    src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js">
  </script>
  <script 
    src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js">
  </script>
  <script 
    src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js">
  </script>
  <script 
    src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js">
  </script>
  <script 
    src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js">
  </script>
  <script 
    src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
  </script>

  <style>
    /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    #map { height: 100vh; }
    /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ (Autocomplete) */
    .suggestions {
      position: absolute;
      background: #334155;
      width: calc(100% - 2rem);
      max-height: 200px;
      overflow-y: auto;
      border-radius: .5rem;
      z-index: 1200;
    }
    .suggestion-item {
      padding: .5rem 1rem;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #475569;
    }
  </style>
</head>
<body class="bg-slate-900 text-white font-sans">

  <!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div id="map"></div>

  <!-- Ø²Ø± Ø§Ù„ÙØªØ­/Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ -->
  <div 
    id="toggleBtn" 
    class="fixed bottom-5 right-5 w-14 h-14 bg-green-500 rounded-full flex items-center justify-center shadow-lg z-50 hover:scale-105 transition-transform"
  >
    <svg 
      xmlns="http://www.w3.org/2000/svg" 
      width="24" height="24" viewBox="0 0 24 24"
    >
      <path fill="#fff" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
  </div>

  <!-- Ø§Ù„Ù€ Bottom Sheet -->
  <div 
    id="sheet" 
    class="fixed bottom-[-100%] left-0 right-0 h-3/5 bg-slate-800 backdrop-blur-lg rounded-t-2xl p-5 flex flex-col transition-all z-40"
  >
    <h2 class="text-xl mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</h2>
    <!-- Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <input 
      id="originInput" 
      class="mb-3 p-3 rounded-lg bg-slate-700 w-full" 
      placeholder="Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©" 
      readonly 
    />
    <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª -->
    <div class="relative w-full mb-3">
      <input 
        id="addressInput" 
        type="text" 
        class="p-3 rounded-lg bg-slate-700 w-full" 
        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ÙˆØ§Ù†..."
      />
      <div id="suggestions" class="suggestions hidden"></div>
    </div>
    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <button 
      id="addBtn" 
      class="mb-3 p-3 rounded-lg bg-green-500 font-bold"
    >
      â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    </button>
    <div 
      id="list" 
      class="flex-1 overflow-y-auto bg-slate-700 rounded-lg p-2 mb-3"
    ></div>
    <button 
      id="routeBtn" 
      class="p-3 rounded-lg bg-sky-500 font-bold"
    >
      ğŸš— Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ†Ù‚Ù„
    </button>
  </div>

  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  <div 
    id="loader" 
    class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 px-4 py-2 rounded-lg hidden z-50"
  >
    Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...
  </div>

  <script>
    // Utility: debounce 
    function debounce(fn, delay) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // State
    const state = {
      origin: null,
      addresses: JSON.parse(localStorage.getItem('addresses')) || []
    };

    // Ø¹Ù†Ø§ØµØ± DOM
    const map = L.map('map').setView([24, 45], 6);
    const originInput = document.getElementById('originInput');
    const addressInput = document.getElementById('addressInput');
    const suggestionsEl = document.getElementById('suggestions');
    const listEl = document.getElementById('list');
    const loader = document.getElementById('loader');
    let routingControl;

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    const markersCluster = L.markerClusterGroup().addTo(map);

    // Service Worker Ù„Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ† 
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ sheet Ù…Ø¹ Hammer.js
    const sheet = document.getElementById('sheet');
    document.getElementById('toggleBtn').onclick = () => {
      sheet.classList.toggle('bottom-0');
    };
    const hammer = new Hammer(sheet);
    hammer.get('pan').set({ direction: Hammer.DIRECTION_VERTICAL });
    hammer.on('panend', ev => {
      if (ev.deltaY > 100) sheet.classList.remove('bottom-0');
    });

    // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ loader
    function showLoader(){ loader.classList.remove('hidden'); }
    function hideLoader(){ loader.classList.add('hidden'); }

    // ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    function setOrigin(latlng, name) {
      state.origin = { lat: latlng.lat, lng: latlng.lng, name };
      localStorage.setItem('origin', JSON.stringify(state.origin));
      originInput.value = name;
      if (window.originMarker) map.removeLayer(window.originMarker);
      window.originMarker = L.marker(latlng, { draggable: true })
        .addTo(map)
        .bindPopup(name).openPopup();
      window.originMarker.on('dragend', e => {
        setOrigin(e.target.getLatLng(), name);
      });
    }

    // ØªØ­Ù…ÙŠÙ„ origin Ø§Ù„Ù…Ø­ÙÙˆØ¸
    const savedOrigin = JSON.parse(localStorage.getItem('origin'));
    if (savedOrigin) {
      setOrigin(L.latLng(savedOrigin.lat, savedOrigin.lng), savedOrigin.name);
    } else {
      // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
      navigator.geolocation.getCurrentPosition(pos => {
        const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
        geocode(ll, res => {
          if(res) setOrigin(ll, res.display_name);
        });
      });
    }

    // Geocode Ø¹Ø§Ù…
    function geocode(query, cb) {
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => cb(data[0] || null))
        .catch(() => cb(null));
    }

    // Autocomplete Ù…Ø¹ debounce
    addressInput.addEventListener('input', debounce(ev => {
      const q = ev.target.value.trim();
      if (!q) return suggestionsEl.classList.add('hidden');
      fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(list => {
          suggestionsEl.innerHTML = '';
          list.forEach(item => {
            const div = document.createElement('div');
            div.textContent = item.display_name;
            div.className = 'suggestion-item';
            div.onclick = () => {
              addAddress(item);
              suggestionsEl.classList.add('hidden');
              addressInput.value = '';
            };
            suggestionsEl.appendChild(div);
          });
          suggestionsEl.classList.toggle('hidden', list.length === 0);
        });
    }, 300));

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù†
    function addAddress(item) {
      state.addresses.push({
        name: item.display_name,
        lat: parseFloat(item.lat),
        lng: parseFloat(item.lon)
      });
      localStorage.setItem('addresses', JSON.stringify(state.addresses));
      renderAddresses();
      addMarker(item);
    }

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    function renderAddresses() {
      listEl.innerHTML = '';
      state.addresses.forEach((addr, i) => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-slate-700 rounded-lg p-2 mb-2';
        div.innerHTML = `
          <span>${addr.name}</span>
          <div class="space-x-2">
            <button onclick="editAddress(${i})">âœï¸</button>
            <button onclick="deleteAddress(${i})">ğŸ—‘ï¸</button>
          </div>
        `;
        listEl.appendChild(div);
      });
      new Sortable(listEl, {
        animation: 150,
        onEnd: () => {
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø­Ø¨
          const newOrder = [...listEl.children].map(el => {
            const txt = el.querySelector('span').textContent;
            return state.addresses.find(a => a.name === txt);
          });
          state.addresses = newOrder;
          localStorage.setItem('addresses', JSON.stringify(state.addresses));
        }
      });
    }

    window.deleteAddress = i => {
      Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
      }).then(res => {
        if (res.isConfirmed) {
          state.addresses.splice(i,1);
          localStorage.setItem('addresses', JSON.stringify(state.addresses));
          renderAddresses();
          updateMarkers();
        }
      });
    };

    window.editAddress = i => {
      const newName = prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯', state.addresses[i].name);
      if (newName) {
        state.addresses[i].name = newName;
        localStorage.setItem('addresses', JSON.stringify(state.addresses));
        renderAddresses();
      }
    };

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø±ÙƒØ±Ø§Øª
    function updateMarkers() {
      markersCluster.clearLayers();
      state.addresses.forEach(addMarker);
    }
    function addMarker(item) {
      const m = L.marker([item.lat, item.lng]).bindPopup(item.display_name || item.name);
      markersCluster.addLayer(m);
    }

    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    state.addresses.forEach(addMarker);
    renderAddresses();

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
    document.getElementById('routeBtn').onclick = () => {
      if (!state.origin || state.addresses.length===0) {
        return Swal.fire('Ø®Ø·Ø£','Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ£Ø¶Ù Ø¹Ù†Ø§ÙˆÙŠÙ†','error');
      }
      if (routingControl) map.removeControl(routingControl);
      const wps = [
        L.latLng(state.origin.lat, state.origin.lng),
        ...state.addresses.map(a => L.latLng(a.lat, a.lng))
      ];
      routingControl = L.Routing.control({
        waypoints: wps,
        lineOptions: { styles:[{weight:6}] }
      }).addTo(map);
      routingControl.on('routesfound', e => {
        const r = e.routes[0];
        const dist = (r.summary.totalDistance/1000).toFixed(1);
        const time = Math.round((r.summary.totalTime%3600)/60);
        Swal.fire('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±',`Ø§Ù„Ù…Ø³Ø§ÙØ©: ${dist} ÙƒÙ…<br>Ø§Ù„ÙˆÙ‚Øª: ${time} Ø¯Ù‚Ø§Ø¦Ù‚`,'info');
      });
    };
  </script>
</body>
</html>
