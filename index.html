<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Alwaki Route</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #fff;
      overflow: hidden;
      height: 100%;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    /* شريط الأيقونات الرأسي على اليسار */
    .left-bar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 56px;
      background: #1e293b;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      z-index: 1001;
      box-shadow: -2px 0 4px rgba(0,0,0,0.3);
    }

    .left-bar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      padding: 10px;
      cursor: pointer;
      margin: 4px 0;
    }

    .left-bar button:hover {
      background: #334155;
      border-radius: 8px;
    }

    .left-bar .tooltip {
      position: fixed;
      left: 60px;
      background: #334155;
      padding: 6px 12px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      font-size: 14px;
    }

    .left-bar button:hover + .tooltip {
      opacity: 1;
    }

    .bottom-sheet {
      position: fixed;
      left: 60px;
      right: 0;
      bottom: 0;
      height: 65%;
      background: #1e293b;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      padding: 15px;
      z-index: 1000;
      overflow-y: auto;
      transform: translateY(60%);
      transition: transform 0.3s ease;
    }

    .bottom-sheet.open {
      transform: translateY(0);
    }

    .drag-handle {
      width: 40px;
      height: 5px;
      background: #4b5563;
      border-radius: 3px;
      margin: 0 auto 10px;
      cursor: grab;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.2rem;
      color: #fff;
    }

    .section {
      position: relative;
      margin-bottom: 8px;
    }

    .input-suggest {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      background: #334155;
      color: #fff;
    }

    .suggestions ul {
      position: absolute;
      bottom: calc(100% + 2px);
      left: 0;
      right: 0;
      max-height: 140px;
      overflow-y: auto;
      background: #2a2a2a;
      border-radius: 8px;
      list-style: none;
      padding: 0;
      margin: 0;
      z-index: 1002;
      display: none;
    }

    .suggestions ul li {
      padding: 8px 12px;
      cursor: pointer;
      color: #eee;
    }

    .suggestions ul li:hover {
      background: #555;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 8px;
    }

    .list-item {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      cursor: grab;
    }

    .list-item.drag-over {
      border: 2px dashed #10b981;
    }

    .list-item span {
      flex: 1;
      word-break: break-word;
      color: #ddd;
    }

    .list-item button {
      background: #ef4444;
      border: none;
      border-radius: 6px;
      padding: 6px;
      cursor: pointer;
      color: #fff;
    }

    #addStopBtn {
      width: 100%;
      padding: 12px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #addStopBtn:hover {
      background: #0f9b6f;
    }

    #addStopBtn i {
      margin-left: 8px;
    }

    .directions {
      flex: 1;
      overflow-y: auto;
      background: #24303d;
      border-radius: 8px;
      padding: 10px;
    }

    .directions h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: #fff;
    }

    .directions ol {
      list-style: none;
      padding-left: 0;
    }

    .directions li {
      padding: 8px;
      background: #334155;
      border-radius: 6px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
    }

    .directions li span.desc {
      flex: 1;
      color: #e0e0e0;
    }

    .directions li span.dist {
      margin-left: 8px;
      color: #bbb;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .leaflet-popup-content {
      text-align: right;
      direction: rtl;
    }

    .leaflet-control-container .leaflet-routing-container {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      text-align: right;
    }

    /* أنماط العلامات مع الأسماء */
    .leaflet-marker-icon .marker-label {
      position: absolute;
      top: -30px;
      left: 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 12px;
      pointer-events: none;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <!-- شريط الأيقونات الرأسي -->
  <div class="left-bar">
    <button id="addStopBtn" title="إضافة محطة"><i>➕</i></button>
    <div class="tooltip">أضف محطة</div>
    
    <button id="saveRouteBtn" title="حفظ المسار"><i>💾</i></button>
    <div class="tooltip">حفظ المسار</div>
    
    <button id="importGPXBtn" title="استيراد GPX"><i>📂</i></button>
    <div class="tooltip">استيراد GPX</div>
    
    <button id="exportGPXBtn" title="تصدير GPX"><i>📁</i></button>
    <div class="tooltip">تصدير GPX</div>
    
    <button id="shareRouteBtn" title="مشاركة"><i>🔗</i></button>
    <div class="tooltip">مشاركة</div>
    
    <button id="clearRouteBtn" title="مسح"><i>🗑️</i></button>
    <div class="tooltip">مسح المسار</div>
  </div>
  
  <!-- الخريطة -->
  <div id="map"></div>
  
  <!-- نموذج إخفاء لتحميل ملف GPX -->
  <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;">
  
  <!-- لوحة التحكم الجانبية -->
  <div class="bottom-sheet" id="sheet">
    <div class="drag-handle" id="handle"></div>
    
    <!-- حقل نقطة البداية -->
    <div class="section suggestions">
      <input id="originInput" class="input-suggest" placeholder="نقطة البداية (اضغط للاختيار)">
      <ul id="originSug"></ul>
    </div>
    
    <!-- قائمة المحطات -->
    <div class="list" id="stopsList"></div>
    
    <!-- حقل البحث عن محطة -->
    <div class="section suggestions">
      <input id="stopInput" class="input-suggest" placeholder="ابحث عن محطة توقف أو عنوان كامل">
      <ul id="stopSug"></ul>
    </div>
    
    <!-- خطوات الاتجاهات -->
    <div class="directions" id="directionsPanel">
      <h3>خطوات الاتجاهات</h3>
      <ol id="directionsList"></ol>
    </div>
  </div>

  <script>
    // --- إعداد الخريطة ---
    const map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // --- معايير البحث ---
    const nominatimParams = 'format=json&addressdetails=1&accept-language=ar';
    
    // --- عناصر الواجهة ---
    const sheet = document.getElementById('sheet');
    const handle = document.getElementById('handle');
    const originInput = document.getElementById('originInput');
    const stopsList = document.getElementById('stopsList');
    const stopInput = document.getElementById('stopInput');
    const directionsList = document.getElementById('directionsList');
    
    // --- حالة التطبيق ---
    let originCoords, originMarker, routingControl;
    let stops = JSON.parse(localStorage.getItem('stops') || '[]');
    let stopMarkers = [];
    let detectedCountry = '';
    let countryBoundingBox = null;
    
    // --- عناصر شريط الأيقونات العلوي ---
    const addStopBtn = document.getElementById('addStopBtn');
    const saveRouteBtn = document.getElementById('saveRouteBtn');
    const importGPXBtn = document.getElementById('importGPXBtn');
    const exportGPXBtn = document.getElementById('exportGPXBtn');
    const shareRouteBtn = document.getElementById('shareRouteBtn');
    const clearRouteBtn = document.getElementById('clearRouteBtn');
    const gpxFileInput = document.getElementById('gpxFileInput');

    // --- سحب اللوحة ---
    handle.addEventListener('pointerdown', e => {
      let startY = e.clientY;
      let startT = 60;
      sheet.style.transition = 'none';
      const onDrag = e2 => {
        let dy = (e2.clientY - startY) / window.innerHeight * 100;
        let y = Math.min(Math.max(startT + dy, 0), 60);
        sheet.style.transform = `translateY(${y}%)`;
      };
      const onEnd = e2 => {
        let dy = (e2.clientY - startY) / window.innerHeight * 100;
        startT = Math.min(Math.max(startT + dy, 0), 60);
        sheet.style.transition = 'transform .3s';
        sheet.style.transform = `translateY(${startT}%)`;
        window.removeEventListener('pointermove', onDrag);
        window.removeEventListener('pointerup', onEnd);
      };
      window.addEventListener('pointermove', onDrag);
      window.addEventListener('pointerup', onEnd);
    });

    // --- وظيفة لتحديد موقع البلد بناءً على IP ---
    async function detectCountryFromIP() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        
        if (data.country && data.region) {
          detectedCountry = `${data.region}, ${data.country_name}`;
          
          // البحث عن إحداثيات البلد
          const countryResponse = await fetch(
            `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(data.region + ',' + data.country)}&limit=1`
          );
          const countryData = await countryResponse.json();
          
          if (countryData[0]) {
            map.setView([countryData[0].lat, countryData[0].lon], 6); // عرض الخريطة للبلد
            if (originInput) {
              originInput.placeholder = `موقعك في ${data.region}, ${data.country_name}`;
            }
            
            // حفظ حدود البلد إذا كانت متاحة
            if (countryData[0].boundingbox) {
              countryBoundingBox = [
                [countryData[0].boundingbox[0], countryData[0].boundingbox[2]], // جنوب غرب
                [countryData[0].boundingbox[1], countryData[0].boundingbox[3]]  // شمال شرق
              ];
            }
          } else {
            map.setView([0, 0], 2); // خريطة العالم كخيار افتراضي
          }
        } else {
          map.setView([0, 0], 2); // خريطة العالم كخيار افتراضي
        }
      } catch (error) {
        console.error('فشل في تحديد موقع IP:', error);
        map.setView([0, 0], 2); // خريطة العالم كخيار افتراضي
      }
    }

    // --- وظيفة لتحديث اقتراحات البحث بناءً على البلد ---
    async function updateSuggestionsWithCountry(inputElement, suggestionsElement, query) {
      if (query.length < 2) {
        suggestionsElement.style.display = 'none';
        return;
      }
      
      let finalQuery = query;
      if (detectedCountry && !query.includes(detectedCountry)) {
        finalQuery = `${query}, ${detectedCountry}`;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(finalQuery)}&limit=5`
        );
        const data = await response.json();
        
        suggestionsElement.innerHTML = '';
        suggestionsElement.style.display = 'block';
        
        data.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.display_name;
          li.onclick = () => {
            const label = prompt('اسم النقطة:', item.display_name) || item.display_name;
            inputElement.value = label;
            suggestionsElement.style.display = 'none';
            
            if (inputElement === originInput) {
              originCoords = [+item.lat, +item.lon];
              setOrigin();
              routeStops();
            } else {
              stops.push({ name: label, lat: +item.lat, lon: +item.lon });
              localStorage.setItem('stops', JSON.stringify(stops));
              updateStops();
              routeStops();
            }
          };
          suggestionsElement.appendChild(li);
        });
      } catch (error) {
        console.error('خطأ في البحث:', error);
      }
    }

    // --- عند تحميل الصفحة ---
    window.onload = async () => {
      // تحديد البلد بناءً على IP
      await detectCountryFromIP();
      
      // إضافة زر يدوي لتحديد الموقع (لـ Safari)
      const locationBtn = document.createElement('button');
      locationBtn.id = 'manualLocationBtn';
      locationBtn.style = `
        position: fixed;
        left: 10px;
        bottom: 70px;
        z-index: 1000;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        cursor: pointer;
        transition: background 0.3s;
      `;
      locationBtn.innerHTML = '📍';
      locationBtn.title = 'استخدم موقعي الحالي';
      document.body.appendChild(locationBtn);
      
      // ربط الزر بوظيفة تحديد الموقع
      locationBtn.addEventListener('click', requestLocation);
      
      // تحديث قائمة المحطات
      updateStops();
    };

    // --- وظيفة لطلب الموقع ---
    function requestLocation() {
      if (!navigator.geolocation) {
        alert('الموقع غير مدعوم في هذا المتصفح');
        return;
      }
      
      originInput.value = 'جاري تحديد موقعك...';
      
      navigator.geolocation.getCurrentPosition(
        position => {
          originCoords = [position.coords.latitude, position.coords.longitude];
          originInput.value = 'موقعي الحالي';
          setOrigin();
          routeStops();
        },
        error => {
          console.warn('خطأ في تحديد الموقع:', error);
          originInput.value = 'موقعي الحالي';
          alert('لم تتم الموافقة على الوصول للموقع أو حدث خطأ في تحديده');
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    }

    // --- تحديد نقطة البداية ---
    function setOrigin() {
      if (originMarker) map.removeLayer(originMarker);
      
      originMarker = L.marker(originCoords).addTo(map);
      
      // إنشاء أيقونة مخصصة مع اسم
      const customIcon = L.divIcon({
        className: 'marker-label',
        html: `<div class="leaflet-marker-icon">${originInput.value}</div>`,
        iconSize: [100, 20],
        iconAnchor: [50, 20],
        popupAnchor: [0, -15]
      });
      
      originMarker.setIcon(customIcon);
      originMarker.bindPopup('نقطة البداية').openPopup();
      
      map.setView(originCoords, 14);
    }

    // --- البحث عن نقطة البداية ---
    originInput.addEventListener('input', () => {
      updateSuggestionsWithCountry(originInput, originSug, originInput.value);
    });

    // --- البحث عن محطات ---
    stopInput.addEventListener('input', () => {
      updateSuggestionsWithCountry(stopInput, stopSug, stopInput.value);
    });

    // --- وظيفة تحديث الاقتراحات مع دعم البلد ---
    async function updateSuggestionsWithCountry(inputElement, suggestionsElement, query) {
      if (!suggestionsElement) {
        suggestionsElement = document.getElementById(inputElement.id === 'originInput' ? 'originSug' : 'stopSug');
      }
      
      if (query.length < 2) {
        suggestionsElement.style.display = 'none';
        return;
      }
      
      // إضافة اسم البلد إلى الاستعلام إذا لم يكن موجودًا
      let finalQuery = query;
      if (detectedCountry && !query.includes(detectedCountry)) {
        finalQuery += `, ${detectedCountry}`;
      }
      
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(finalQuery)}&limit=5`
        );
        const data = await response.json();
        suggestionsElement.innerHTML = '';
        suggestionsElement.style.display = 'block';
        
        data.forEach(p => {
          const li = document.createElement('li');
          li.textContent = p.display_name;
          li.onclick = () => {
            const label = prompt('اسم النقطة:', p.display_name) || p.display_name;
            inputElement.value = label;
            suggestionsElement.style.display = 'none';
            
            if (inputElement === originInput) {
              originCoords = [+p.lat, +p.lon];
              setOrigin();
              routeStops();
            } else {
              stops.push({ name: label, lat: +p.lat, lon: +p.lon });
              localStorage.setItem('stops', JSON.stringify(stops));
              updateStops();
              stopInput.value = '';
              routeStops();
            }
          };
          suggestionsElement.appendChild(li);
        });
      } catch (error) {
        console.error('خطأ في البحث:', error);
      }
    }

    // --- النقر على الخريطة لإضافة محطة ---
    map.on('click', async e => {
      const { lat, lng } = e.latlng;
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?${nominatimParams}&lat=${lat}&lon=${lng}`
        );
        const data = await response.json();
        const displayName = data.display_name || 'موقع غير معروف';
        const name = prompt('الرجاء إدخال اسم للمحطة:', displayName) || displayName;
        
        // التأكد من أن الموقع داخل حدود البلد
        if (countryBoundingBox) {
          const lat = parseFloat(data.lat);
          const lon = parseFloat(data.lon);
          if (lat < countryBoundingBox[0][0] || lat > countryBoundingBox[1][0] ||
              lon < countryBoundingBox[0][1] || lon > countryBoundingBox[1][1]) {
            if (!confirm('النقطة خارج نطاق بلدك. هل تريد إضافتها؟')) {
              return;
            }
          }
        }
        
        stops.push({ name, lat, lon });
        localStorage.setItem('stops', JSON.stringify(stops));
        updateStops();
        routeStops();
      } catch (error) {
        alert('خطأ في تحديد الموقع');
        console.error('Error reverse geocoding:', error);
      }
    });

    // --- إضافة محطة ---
    addStopBtn.addEventListener('click', () => {
      if (!originCoords && stops.length === 0) {
        alert('يرجى تحديد نقطة البداية أولًا');
        return;
      }
      
      const q = stopInput.value.trim();
      if (!q) return;
      
      fetch(`https://nominatim.openstreetmap.org/search?${nominatimParams}&q=${encodeURIComponent(q)}&limit=1`)
        .then(response => response.json())
        .then(data => {
          if (data[0]) {
            const name = prompt('اسم مخصص:', data[0].display_name) || data[0].display_name;
            stops.push({ name, lat: +data[0].lat, lon: +data[0].lon });
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            stopInput.value = '';
            routeStops();
          }
        })
        .catch(error => {
          alert('حدث خطأ أثناء البحث');
          console.error('Error adding stop:', error);
        });
    });

    // --- حفظ المسار ---
    saveRouteBtn.addEventListener('click', () => {
      if (stops.length === 0 && !originCoords) {
        alert('لا يوجد مسار لحفظه');
        return;
      }
      
      const name = prompt('أدخل اسم المسار:');
      if (!name) return;
      
      const saved = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
      saved.push({ name, origin: originCoords, stops });
      localStorage.setItem('savedRoutes', JSON.stringify(saved));
      alert('تم حفظ المسار');
    });

    // --- مشاركة المسار ---
    shareRouteBtn.addEventListener('click', () => {
      if (!originCoords || stops.length === 0) {
        alert('لا يوجد مسار لمشاركته');
        return;
      }
      
      const routeData = {
        origin: originCoords,
        stops: stops.map(s => [s.lat, s.lon])
      };
      
      const encoded = encodeURIComponent(JSON.stringify(routeData));
      const url = `${window.location.href.split('?')[0]}?route=${encoded}`;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          alert('تم نسخ الرابط للحافظة! يمكنك مشاركته الآن.');
        }).catch(() => {
          prompt('يرجى نسخ الرابط أدناه:', url);
        });
      } else {
        prompt('يرجى نسخ الرابط أدناه:', url);
      }
    });

    // --- تحميل المسار من الرابط ---
    window.addEventListener('load', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('route')) {
        try {
          const routeData = JSON.parse(decodeURIComponent(urlParams.get('route')));
          originCoords = routeData.origin;
          originInput.value = 'مسار مشترك';
          stops = routeData.stops.map((coords, index) => ({
            name: `محطة ${index + 1}`,
            lat: coords[0],
            lon: coords[1]
          }));
          
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          setOrigin();
          routeStops();
          
          window.history.replaceState({}, '', window.location.pathname);
        } catch (e) {
          console.error('فشل تحميل المسار من الرابط:', e);
        }
      }
    });

    // --- تصدير GPX ---
    exportGPXBtn.addEventListener('click', () => {
      if (!originCoords && stops.length === 0) {
        alert('لا يوجد مسار لتصديره');
        return;
      }
      
      const waypoints = stops.map((s, i) => ({
        lat: s.lat,
        lon: s.lon,
        name: s.name || `محطة ${i + 1}`
      }));
      
      if (waypoints.length < 1) {
        alert('لا توجد نقاط لتصديرها');
        return;
      }
      
      let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Alwaki Route" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>مسار من Alwaki Route</name>
    <desc>تم إنشاء المسار باستخدام Alwaki Route</desc>
    <time>${new Date().toISOString()}</time>
  </metadata>`;
      
      waypoints.forEach(w => {
        gpx += `<wpt lat="${w.lat}" lon="${w.lon}">
  <name>${w.name}</name>
  <desc>نقطة من Alwaki Route</desc>
</wpt>`;
      });
      
      gpx += `</gpx>`;
      
      const blob = new Blob([gpx], { type: 'application/gpx+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `alwaki-route-${Date.now()}.gpx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // --- استيراد GPX ---
    importGPXBtn.addEventListener('click', () => {
      gpxFileInput.click();
    });

    gpxFileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = () => {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(reader.result, "text/xml");
        
        const gpxNodes = xmlDoc.getElementsByTagName('wpt');
        if (gpxNodes.length === 0) {
          alert('الملف لا يحتوي على نقاط مسار');
          return;
        }
        
        stops = [];
        for (let i = 0; i < gpxNodes.length; i++) {
          const node = gpxNodes[i];
          const lat = parseFloat(node.getAttribute('lat'));
          const lon = parseFloat(node.getAttribute('lon'));
          const nameElement = node.getElementsByTagName('name')[0];
          const name = nameElement ? nameElement.textContent : `محطة ${i + 1}`;
          
          if (!isNaN(lat) && !isNaN(lon)) {
            stops.push({ name, lat, lon });
          }
        }
        
        if (stops.length > 0) {
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
          alert(`تم استيراد ${stops.length} نقطة بنجاح`);
        } else {
          alert('فشل قراءة النقاط من ملف GPX');
        }
      };
      
      reader.onerror = () => {
        alert('خطأ في قراءة ملف GPX');
      };
      
      reader.readAsText(file);
    });

    // --- مسح المسار ---
    clearRouteBtn.addEventListener('click', () => {
      if (!confirm('هل تريد مسح كل المحطات والنقطة البداية؟')) return;
      
      stops = [];
      originCoords = null;
      originInput.value = '';
      if (originMarker) {
        map.removeLayer(originMarker);
        originMarker = null;
      }
      
      localStorage.removeItem('stops');
      updateStops();
      if (routingControl) map.removeControl(routingControl);
      directionsList.innerHTML = '';
    });

    // --- تحديث قائمة المحطات ---
    function updateStops() {
      stopsList.innerHTML = '';
      if (stopMarkers) {
        stopMarkers.forEach(marker => map.removeLayer(marker));
      }
      stopMarkers = [];
      
      stops.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.draggable = true;
        div.dataset.index = i;
        div.innerHTML = `<span>${s.name}</span><button onclick="delStop(${i})">🗑️</button>`;
        
        div.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text', i);
        });
        
        div.addEventListener('dragover', e => {
          e.preventDefault();
          div.classList.add('drag-over');
        });
        
        div.addEventListener('dragleave', () => {
          div.classList.remove('drag-over');
        });
        
        div.addEventListener('drop', e => {
          const from = +e.dataTransfer.getData('text');
          stops.splice(i, 0, stops.splice(from, 1)[from]);
          localStorage.setItem('stops', JSON.stringify(stops));
          updateStops();
          routeStops();
        });
        
        div.querySelector('span').onclick = () => {
          const newStopName = prompt('تعديل اسم المحطة:', s.name);
          if (newStopName) {
            stops[i].name = newStopName;
            localStorage.setItem('stops', JSON.stringify(stops));
            updateStops();
            routeStops();
          }
        };
        
        stopsList.appendChild(div);
        
        // إنشاء علامة مخصصة مع اسم المحطة
        const customIcon = L.divIcon({
          className: 'marker-label',
          html: `<div class="leaflet-marker-icon">${s.name}</div>`,
          iconSize: [100, 20],
          iconAnchor: [50, 20],
          popupAnchor: [0, -15]
        });
        
        const marker = L.marker([s.lat, s.lon], { icon: customIcon }).addTo(map);
        marker.bindPopup(s.name);
        stopMarkers.push(marker);
      });
    }

    // --- رسم المسار ---
    function routeStops() {
      if (!originCoords || stops.length === 0) {
        if (routingControl) {
          map.removeControl(routingControl);
          routingControl = null;
        }
        directionsList.innerHTML = '';
        return;
      }
      
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      const waypoints = [
        L.latLng(originCoords),
        ...stops.map(s => L.latLng(s.lat, s.lon))
      ];
      
      if (waypoints.length < 2) return;
      
      routingControl = L.Routing.control({
        waypoints: waypoints,
        lineOptions: { styles: [{ color: '#38bdf8', weight: 5 }] },
        routeWhileDragging: false,
        show: false,
        formatter: new L.Routing.Formatter({ language: 'ar', units: 'metric' })
      }).addTo(map);
      
      routingControl.on('routesfound', e => {
        directionsList.innerHTML = '';
        
        if (!e.routes || e.routes.length === 0) {
          directionsList.innerHTML = '<li>لم يتم العثور على مسار</li>';
          return;
        }
        
        e.routes[0].instructions.forEach(inst => {
          const li = document.createElement('li');
          li.innerHTML = `<span class="desc">${inst.text}</span><span class="dist">${(inst.distance/1000).toFixed(1)} كم</span>`;
          directionsList.appendChild(li);
        });
      });
    }

    // --- حذف محطة ---
    window.delStop = i => {
      stops.splice(i, 1);
      localStorage.setItem('stops', JSON.stringify(stops));
      updateStops();
      routeStops();
    };

    // --- تحديث نقطة البداية ---
    function setOrigin() {
      if (originMarker) map.removeLayer(originMarker);
      
      // إنشاء علامة مخصصة مع اسم نقطة البداية
      const customIcon = L.divIcon({
        className: 'marker-label',
        html: `<div class="leaflet-marker-icon">نقطة البداية</div>`,
        iconSize: [100, 20],
        iconAnchor: [50, 20],
        popupAnchor: [0, -15]
      });
      
      originMarker = L.marker(originCoords, { icon: customIcon })
        .addTo(map)
        .bindPopup('نقطة البداية')
        .openPopup();
      
      map.setView(originCoords, 14);
    }

    // --- تحميل المحطات ---
    updateStops();
  </script>
</body>
</html>
